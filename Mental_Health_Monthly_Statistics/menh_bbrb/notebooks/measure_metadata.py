# Databricks notebook source
from pyspark.sql import functions as F

# COMMAND ----------

 %run ./mhsds_functions

# COMMAND ----------

 %run ./breakdown_metadata

# COMMAND ----------

los_measure_ids = {  
"MHS100": {
  "freq": "Q", 
  "name": "The number of people discharged in the RP from adult acute beds aged 18 to 64 with a length of stay of 60+ days",
  "source_table": "spells",
  "filter_clause": (F.col("Acute_Bed") == "Adult Acute") & (F.col("Hosp_LOS") >= 60) & (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": "COALESCE(COUNT(DISTINCT Person_ID),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS100",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS140": {
  "freq": "Q", 
  "name": "The number of people discharged in the RP from adult acute beds aged 18 to 64",
  "source_table": "spells",
  "filter_clause": (F.col("Acute_Bed") == "Adult Acute") & (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": "COALESCE(COUNT(DISTINCT Person_ID),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS140",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS140a": {
  "freq": "Q", 
  "name": "The mean length of stay in days of people discharged in the RP from adult acute beds aged 18 to 64",
  "source_table": "spells",
  "filter_clause": (F.col("Acute_Bed") == "Adult Acute") & (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": "COALESCE(ROUND(AVG(HOSP_LOS),0),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS140",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "mean",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS140b": {
  "freq": "Q", 
  "name": "The median length of stay in days of people discharged in the RP from adult acute beds aged 18 to 64",
  "source_table": "spells",
  "filter_clause": (F.col("Acute_Bed") == "Adult Acute") & (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": "COALESCE(ROUND(percentile(HOSP_LOS, 0.5),0),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS140",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS141": {
  "freq": "Q", 
  "name":  "The number of people discharged in the RP from older adult acute beds aged 65 and over",
  "source_table": "spells",
  "filter_clause": (F.col("Acute_Bed") == "Older Adult Acute") & (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": "COALESCE(COUNT(DISTINCT Person_ID),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS141",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS141a": {
  "freq": "Q", 
  "name":  "The mean length of stay in days of people discharged in the RP from adult acute beds aged 65 and over",
  "source_table": "spells",
  "filter_clause": (F.col("Acute_Bed") == "Older Adult Acute") & (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": "COALESCE(ROUND(AVG(HOSP_LOS),0),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS141",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "mean",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS141b": {
  "freq": "Q", 
  "name":  "The median length of stay in days of people discharged in the RP from adult acute beds aged 65 and over",
  "source_table": "spells",
  "filter_clause": (F.col("Acute_Bed") == "Older Adult Acute") & (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": "COALESCE(ROUND(percentile(HOSP_LOS, 0.5),0),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS141",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS142": {
  "freq": "Q", 
  "name": "The number of people discharged in the RP aged 0 to 17",
  "source_table": "spells",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": "COALESCE(COUNT(DISTINCT Person_ID),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS142",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS142a": {
  "freq": "Q", 
  "name": "The mean length of stay in days of people discharged in the RP aged 0 to 17",
  "source_table": "spells",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": "COALESCE(ROUND(AVG(HOSP_LOS),0),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS142",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "mean",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS142b": {
  "freq": "Q", 
  "name": "The median length of stay in days of people discharged in the RP aged 0 to 17",
  "source_table": "spells",
  "filter_clause": (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": "COALESCE(ROUND(percentile(HOSP_LOS, 0.5),0),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS142",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS100a": {
  "freq": "Q", 
  "name": "Rate of people discharged per 100,000 in the RP from adult acute beds aged 18 to 64 with a length of stay of 60+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100000",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS100",
  "denominator": "MHSPOPADU",
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS100b": {
  "freq": "Q", 
  "name": "Proportion of people discharged in the RP from adult acute beds aged 18 to 64 with a length of stay of 60+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS100",
  "denominator": "MHS140",
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS101": {
  "freq": "Q", 
  "name": "The number of people discharged in the RP from adult acute beds aged 18 to 64 with a length of stay of 90+ days",
  "source_table": "spells",
  "filter_clause": (F.col("Acute_Bed") == "Adult Acute") & (F.col("Hosp_LOS") >= 90) & (F.col("AgeRepPeriodEnd").between(18, 64)),
  "aggregate_field": "COALESCE(COUNT(DISTINCT Person_ID),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS101",
  "denominator": 0,
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS101a": {
  "freq": "Q", 
  "name":  "Rate of people discharged per 100,000 in the RP from adult acute beds aged 18 to 64 with a length of stay of 90+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100000",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS101",
  "denominator": "MHSPOPADU",
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS101b": {
  "freq": "Q", 
  "name": "Proportion of people discharged in the RP from adult acute beds aged 18 to 64 with a length of stay of 90+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS101",
  "denominator": "MHS140",  
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS102": {
  "freq": "Q", 
  "name":  "The number of people discharged in the RP from older adult acute beds aged 65 and over with a length of stay of 60+ days",
  "source_table": "spells",
  "filter_clause": (F.col("Acute_Bed") == "Older Adult Acute") & (F.col("Hosp_LOS") >= 60) & (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": "COALESCE(COUNT(DISTINCT Person_ID),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS102",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS102a": {
  "freq": "Q", 
  "name":  "Rate of people discharged per 100,000 in the RP from older adult acute beds aged 65 and over with a length of stay of 60+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100000",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS102",
  "denominator": "MHSPOPOAP",  
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS102b": {
  "freq": "Q", 
  "name": "Proportion of people discharged in the RP from older adult acute beds aged 65 and over with a length of stay of 60+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS102",
  "denominator": "MHS141",  
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS103": {
  "freq": "Q", 
  "name": "The number of people discharged in the RP from older adult acute beds aged 65 and over with a length of stay of 90+ days",
  "source_table": "spells",
  "filter_clause": (F.col("Acute_Bed") == "Older Adult Acute") & (F.col("Hosp_LOS") >= 90) & (F.col("AgeRepPeriodEnd") >= 65),
  "aggregate_field": "COALESCE(COUNT(DISTINCT Person_ID),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS103",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS103a": {
  "freq": "Q", 
  "name": "Rate of people discharged per 100,000 in the RP from older adult acute beds aged 65 and over with a length of stay of 90+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100000",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS103",
  "denominator": "MHSPOPOAP",  
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS103b": {
  "freq": "Q", 
  "name": "Proportion of people discharged in the RP from older adult acute beds aged 65 and over with a length of stay of 90+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS103",
  "denominator": "MHS141",  
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS104": {
  "freq": "Q", 
  "name": "The number of people discharged in the RP aged 0 to 17 with a length of stay of 60+ days",
  "source_table": "spells",
  "filter_clause": (F.col("Hosp_LOS") >= 60) & (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": "COALESCE(COUNT(DISTINCT Person_ID),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS104",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS104a": {
  "freq": "Q", 
  "name": "Rate of people discharged per 100,000 in the RP aged 0 to 17 with a length of stay of 60+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100000",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS104",
  "denominator": "MHSPOPCYP",  
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS104b": {
  "freq": "Q", 
  "name": "Proportion of people discharged in the RP aged 0 to 17 with a length of stay of 60+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS104",
  "denominator": "MHS142",  
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS105": {
  "freq": "Q", 
  "name": "The number of people discharged in the RP aged 0 to 17 with a length of stay of 90+ days",
  "source_table": "spells",
  "filter_clause": (F.col("Hosp_LOS") >= 90) & (F.col("AgeRepPeriodEnd").between(0, 17)),
  "aggregate_field": "COALESCE(COUNT(DISTINCT Person_ID),0)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "MHS105",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS105a": {
  "freq": "Q", 
  "name": "Rate of people discharged per 100,000 in the RP aged 0 to 17 with a length of stay of 90+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100000",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS105",
  "denominator": "MHSPOPCYP",  
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"MHS105b": {
  "freq": "Q", 
  "name": "Proportion of people discharged in the RP aged 0 to 17 with a length of stay of 90+ days",
  "source_table": "spells_rates",
  "filter_clause": "",
  "aggregate_field": "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100",
  "aggregate_function": produce_crude_rate_agg_df,
  "numerator_id": "MHS105",
  "denominator": "MHS142",  
  "crude_rate": 1,
  "related_to": "people",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
}

# COMMAND ----------

four_ww_measure_ids = {
  "MRS01": {
  "freq": "Q", 
  "name": "Number of CMH referral-spells receiving a full clock stop in the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP BETWEEN REPORTINGPERIODSTARTDATE AND REPORTINGPERIODENDDATE THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MRS01",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS01a": {
  "freq": "Q", 
  "name": "Number of CMH referral-spells receiving a full clock stop less than 4 weeks in the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP BETWEEN REPORTINGPERIODSTARTDATE AND REPORTINGPERIODENDDATE AND Time_to_clock_stop <= 28 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MRS01a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS01b": {
  "freq": "Q", 
  "name": "Proportion of CMH referral-spells entering treatment less than 4 weeks in the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP BETWEEN REPORTINGPERIODSTARTDATE AND REPORTINGPERIODENDDATE AND Time_to_clock_stop <= 28 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP BETWEEN REPORTINGPERIODSTARTDATE AND REPORTINGPERIODENDDATE THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MRS01a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS02": {
  "freq": "M", 
  "name": "Number of CMH referral-spells waiting for a full clock stop that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS02",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS02a": {
  "freq": "M", 
  "name": "Number of CMH referral-spells waiting more than 104 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 728 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS02a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS02b": {
  "freq": "M", 
  "name": "Proportion of CMH referral-spells waiting more than 104 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 728 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS02a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS02c": {
  "freq": "M", 
  "name": "Number of CMH referral-spells waiting more than 78 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 546 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS02c",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS02d": {
  "freq": "M", 
  "name": "Proportion of CMH referral-spells waiting more than 78 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 546 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS02c",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS02e": {
  "freq": "M", 
  "name": "Number of CMH referral-spells waiting more than 52 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 364 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS02e",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS02f": {
  "freq": "M", 
  "name": "Proportion of CMH referral-spells waiting more than 52 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 364 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS02a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS03": {
  "freq": "M", 
  "name": "Number of open CMH referral-spells waiting for a 2nd contact at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_Open = 1 AND With_2nd_contact = 0 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS03",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS03a": {
  "freq": "M", 
  "name": "90th percentile time (days) for open CMH referral-spells waiting for a 2nd contact at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "PERCENTILE(DISTINCT CASE WHEN Spell_Open = 1 AND With_2nd_contact = 0 THEN Time_start_to_end_rp ELSE NULL END, 0.9)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS03",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS04": {
  "freq": "Q", 
  "name": "Number of CMH referral-spells that started in the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_start = 1 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MRS04",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS05": {
  "freq": "Q", 
  "name": "Number of CMH referral-spells that closed in the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_closed = 1 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MRS05",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS06": {
  "freq": "M", 
  "name": "Number of CMH referral-spells that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_open = 1 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS06",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS07a": {
  "freq": "M", 
  "name": "Number of CMH referral-spells waiting more than 104 weeks for a 2nd contact that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_2nd_contact = 0 AND Time_start_to_end_rp > 728 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS07a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS07b": {
  "freq": "M", 
  "name": "Proportion of CMH referral-spells waiting more than 104 weeks for a 2nd contact that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_2nd_contact = 0 AND Time_start_to_end_rp > 728 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_2nd_contact = 0 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS07a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS07c": {
  "freq": "M", 
  "name": "Number of CMH referral-spells waiting more than 78 weeks for a 2nd contact that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_2nd_contact = 0 AND Time_start_to_end_rp > 546 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS07c",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS07d": {
  "freq": "M", 
  "name": "Proportion of CMH referral-spells waiting more than 78 weeks for a 2nd contact that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_2nd_contact = 0 AND Time_start_to_end_rp > 546 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_2nd_contact = 0 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS07c",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS07e": {
  "freq": "M", 
  "name": "Number of CMH referral-spells waiting more than 52 weeks for a 2nd contact that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_2nd_contact = 0 AND Time_start_to_end_rp > 364 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS07e",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS07f": {
  "freq": "M", 
  "name": "Proportion of CMH referral-spells waiting more than 52 weeks for a 2nd contact that were still open at the end of the RP",
  "source_table": "cmh_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_2nd_contact = 0 AND Time_start_to_end_rp > 364 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_2nd_contact = 0 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS07e",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS08": {
  "freq": "Q", 
  "name": "Number of CYP referral-spells receiving a full clock stop in the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP BETWEEN REPORTINGPERIODSTARTDATE AND REPORTINGPERIODENDDATE THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MRS08",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS08a": {
  "freq": "Q", 
  "name": "Number of CYP referral-spells receiving a full clock stop less than 4 weeks in the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP BETWEEN REPORTINGPERIODSTARTDATE AND REPORTINGPERIODENDDATE AND Time_to_clock_stop <= 28 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MRS08a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS08b": {
  "freq": "Q", 
  "name": "Proportion of CYP referral-spells entering treatment less than 4 weeks in the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP BETWEEN REPORTINGPERIODSTARTDATE AND REPORTINGPERIODENDDATE AND Time_to_clock_stop <= 28 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP BETWEEN REPORTINGPERIODSTARTDATE AND REPORTINGPERIODENDDATE THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MRS08a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS09": {
  "freq": "M", 
  "name": "Number of CYP referral-spells waiting for a full clock stop that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS09",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS09a": {
  "freq": "M", 
  "name": "Number of CYP referral-spells waiting more than 104 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 728 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS09a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS09b": {
  "freq": "M", 
  "name": "Proportion of CYP referral-spells waiting more than 104 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 728 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS09a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS09c": {
  "freq": "M", 
  "name": "Number of CYP referral-spells waiting more than 78 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 546 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS09c",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS09d": {
  "freq": "M", 
  "name": "Proportion of CYP referral-spells waiting more than 78 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 546 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS09c",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS09e": {
  "freq": "M", 
  "name": "Number of CYP referral-spells waiting more than 52 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 364 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS09e",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS09f": {
  "freq": "M", 
  "name": "Proportion of CYP referral-spells waiting more than 52 weeks for full clock stop that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 AND Time_start_to_end_rp > 364 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN PATHWAY_CLOCKSTOP IS NULL AND Spell_Open = 1 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS09e",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS10": {
  "freq": "M", 
  "name": "Number of open CYP referral-spells waiting for a 1st contact at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_Open = 1 AND With_1st_contact = 0 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS10",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS10a": {
  "freq": "M", 
  "name": "90th percentile time (days) for open CYP referral-spells waiting for a 1st contact at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "PERCENTILE(DISTINCT CASE WHEN Spell_Open = 1 AND With_1st_contact = 0 THEN Time_start_to_end_rp ELSE NULL END, 0.9)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS10",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS11": {
  "freq": "Q", 
  "name": "Number of CYP referral-spells that started in the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_start = 1 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MRS11",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS12": {
  "freq": "Q", 
  "name": "Number of CYP referral-spells that closed in the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_closed = 1 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MRS12",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS13": {
  "freq": "M", 
  "name": "Number of CYP referral-spells that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_open = 1 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS13",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS14a": {
  "freq": "M", 
  "name": "Number of CYP referral-spells waiting more than 104 weeks for a 1st contact that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_1st_contact = 0 AND Time_start_to_end_rp > 728 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS14a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS14b": {
  "freq": "M", 
  "name": "Proportion of CYP referral-spells waiting more than 104 weeks for a 1st contact that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_1st_contact = 0 AND Time_start_to_end_rp > 728 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_1st_contact = 0 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS14a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS14c": {
  "freq": "M", 
  "name": "Number of CYP referral-spells waiting more than 78 weeks for a 1st contact that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_1st_contact = 0 AND Time_start_to_end_rp > 546 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS14c",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS14d": {
  "freq": "M", 
  "name": "Proportion of CYP referral-spells waiting more than 78 weeks for a 1st contact that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_1st_contact = 0 AND Time_start_to_end_rp > 546 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_1st_contact = 0 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS14c",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS14e": {
  "freq": "M", 
  "name": "Number of CYP referral-spells waiting more than 52 weeks for a 1st contact that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_1st_contact = 0 AND Time_start_to_end_rp > 364 THEN SpellID ELSE NULL END)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS14e",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
  "MRS14f": {
  "freq": "M", 
  "name": "Proportion of CYP referral-spells waiting more than 52 weeks for a 1st contact that were still open at the end of the RP",
  "source_table": "cyp_4ww_spell_master_long",
  "filter_clause": "",
  "aggregate_field": "CAST((COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_1st_contact = 0 AND Time_start_to_end_rp > 364 THEN SpellID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Spell_open = 1 AND With_1st_contact = 0 THEN SpellID ELSE NULL END))*100 AS FLOAT)",
  "aggregate_function": produce_date_filter_agg_df,
  "numerator_id": "MRS14e",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "patient spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, stp_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
}

# COMMAND ----------

cmh_measure_ids = {  
"MHS106": {
  "freq": "Q", 
  "name": "Acute admissions in the RP",
  "source_table": "cmh_agg",
  "filter_clause": "",
  "aggregate_field": "CAST(SUM(Admissions) AS INT)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS106",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "hospital_spells",
  "suppression": "count",
  "breakdowns": [eng_bd, wnw_eth_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, stp_prac_res_wnw_eth_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS106a": {
  "freq": "Q", 
  "name": "Acute admissions with previous contact to MH services in the RP",
  "source_table": "cmh_agg",
  "filter_clause": "",
  "aggregate_field": "CAST(SUM(Contact) AS INT)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS106a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "hospital_spells",
  "suppression": "count",
  "breakdowns": [eng_bd, wnw_eth_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, stp_prac_res_wnw_eth_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS106b": {
  "freq": "Q", 
  "name": "Acute admissions with no previous contact to MH services in the RP",
  "source_table": "cmh_agg",
  "filter_clause": "",
  "aggregate_field": "CAST(SUM(NoContact) AS INT)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS106b",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "hospital_spells",
  "suppression": "count",
  "breakdowns": [eng_bd, wnw_eth_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, stp_prac_res_wnw_eth_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS107a": {
  "freq": "Q", 
  "name":  "Rate of acute admission with previous contact to MH services in the RP",
  "source_table": "cmh_agg",
  "filter_clause": "",
  "aggregate_field": "CAST((SUM(Contact)/SUM(Admissions))*100 AS FLOAT)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS106a",
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "hospital_spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, wnw_eth_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, stp_prac_res_wnw_eth_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS107b": {
  "freq": "Q", 
  "name":  "Rate of acute admission with no previous contact to MH services in the RP",
  "source_table": "cmh_agg",
  "filter_clause": "",
  "aggregate_field": "CAST((SUM(NoContact)/SUM(Admissions))*100 AS FLOAT)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS106b",
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "hospital_spells",
  "suppression": "percent",
  "breakdowns": [eng_bd, wnw_eth_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, stp_prac_res_wnw_eth_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS108": {
  "freq": "12M", 
  "name":  "Number of people accessing community mental health services for adults and older adults with 2 or more care contacts within the RP",
  "source_table": "cmh_rolling_activity",
  "filter_clause": (F.col("Person_ID").isNotNull()),
  "aggregate_field": "COUNT(DISTINCT Person_ID)",
  "aggregate_function": produce_access_filter_agg_df,
  "numerator_id": "MHS108",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS124": {
  "freq": "Q", 
  "name":  "Number of referrals accessing community mental health services for adults and older adults with serious mental illness which received the second contact within the RP (this is based on a three month rolling RP)",
  "source_table": "CMH_Rolling_Activity_medians_2nd_cont",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS124",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS125": {
  "freq": "Q", 
  "name": "Median waiting time between referral and second contact for referrals accessing community mental health services for adults and older adults with serious mental illness which received the second contact within the RP (this is based on a three month rolling RP)",
  "source_table": "CMH_Rolling_Activity_medians_2nd_cont",
  "filter_clause": "",
  "aggregate_field": "PERCENTILE(TIME_TO_2ND_CONTACT,0.5)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS124",
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS126": {
  "freq": "Q", 
  "name": "90th Percentile waiting time between referral and second contact for referrals accessing community mental health services for adults and older adults with serious mental illness which received the second contact within the RP (this is based on a three month rolling RP)",
  "source_table": "CMH_Rolling_Activity_medians_2nd_cont",
  "filter_clause": "",
  "aggregate_field": "PERCENTILE(TIME_TO_2ND_CONTACT,0.9)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS124",
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS127": {
  "freq": "Q", 
  "name": "Number of referrals accessing community mental health services for adults and older adults with serious mental illness still waiting for a second contact within the RP that were open at the end of the RP",
  "source_table": "CMH_Rolling_Activity_medians_still_waiting",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS127",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS128": {
  "freq": "Q", 
  "name": "Median waiting time between referral and the end of the reporting period  for referrals accessing community mental health services for adults and older adults with serious mental illness still waiting for a second contact within the RP that were open at the end of the RP",
  "source_table": "CMH_Rolling_Activity_medians_still_waiting",
  "filter_clause": "",
  "aggregate_field": "PERCENTILE(TimeFromRefToEndRP,0.5)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS127",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS129": {
  "freq": "Q", 
  "name": "90th Percentile waiting time between referral and the end of the reporting period for referrals accessing community mental health services for adults and older adults with serious mental illness still waiting for a second contact within the RP that were open at the end of the RP",
  "source_table": "CMH_Rolling_Activity_medians_still_waiting",
  "filter_clause": "",
  "aggregate_field": "PERCENTILE(TimeFromRefToEndRP,0.9)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS127",
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
}
}

# COMMAND ----------

cyp_peri_measure_ids = {  
"MHS91": {
  "freq": "12M", 
  "name": "Perinatal Access showing the number of people in contact with Specialist Perinatal Mental Health Community Services",
  "source_table": "perinatal_m_master",
  "filter_clause": (F.col("Person_ID").isNotNull()),
  "aggregate_field": "COUNT(DISTINCT CASE WHEN AttContacts > 0 THEN Person_ID END)",
  "aggregate_function": produce_fy_access_filter_agg_df,
  "numerator_id": "MHS91",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, lower_eth_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS95": {
  "freq": "12M", 
  "name": "Number of CYP aged under 18 supported through NHS funded mental health with at least one contact (12 month rolling)",
  "source_table": "firstcont_final",
  "filter_clause": (F.col("Metric") == "MHS95"),
  "aggregate_field": "COUNT(DISTINCT Person_ID)",
  "aggregate_function": produce_access_filter_agg_df,
  "numerator_id": "MHS95",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, ccg_prac_res_prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS109": {
  "freq": "12M", 
  "name": "Number of people aged 18 to 24 supported through NHS funded mental health with at least one contact (12 month rolling)",
  "source_table": "firstcont_final",
  "filter_clause": (F.col("Metric") == "MHS109"),
  "aggregate_field": "COUNT(DISTINCT Person_ID)",
  "aggregate_function": produce_access_filter_agg_df,
  "numerator_id": "MHS95",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "people",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, ccg_prac_res_prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS130": {
  "freq": "Q", 
  "name": "Number of referrals for CYP aged under 18 supported through NHS funded mental health with a first contact in the RP (3 month rolling)",
  "source_table": "Act_cumulative_master_first_contact",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS130",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},  
"MHS131": {
  "freq": "Q", 
  "name": "Median waiting time between referral start date and first contact in days for referrals for CYP aged under 18 supported through NHS funded mental health with a first contact in the RP (3 month rolling)",
  "source_table": "Act_cumulative_master_first_contact",
  "filter_clause": "",
  "aggregate_field": "PERCENTILE(TimeFromRefToFirstCont,0.50)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS130",
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS132": {
  "freq": "Q", 
  "name": "90th percentile waiting time between referral start date and first contact in days for referrals for CYP aged under 18 supported through NHS funded mental health with a first contact in the RP (3 month rolling)",
  "source_table": "Act_cumulative_master_first_contact",
  "filter_clause": "",
  "aggregate_field": "PERCENTILE(TimeFromRefToFirstCont,0.9)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS130",
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS133": {
  "freq": "Q", 
  "name": "Number of referrals for CYP aged under 18 supported through NHS funded mental health still waiting for a first contact and still waiting at the end of the RP",
  "source_table": "Act_cumulative_master_still_waiting",
  "filter_clause": "",
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS133",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS134": {
  "freq": "Q", 
  "name": "Median waiting time between referral start date and first contact in days for referrals for CYP aged under 18 supported through NHS funded mental health still waiting for a first contact and still waiting at the end of the RP",
  "source_table": "Act_cumulative_master_still_waiting",
  "filter_clause": "",
  "aggregate_field": "PERCENTILE(TimeFromRefToEndRP,0.50)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS133",
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
"MHS135": {
  "freq": "Q", 
  "name": "90th percentile waiting time between referral start date and first contact in days for referrals for CYP aged under 18 supported through NHS funded mental health still waiting for a first contact and still waiting at the end of the RP",
  "source_table": "Act_cumulative_master_still_waiting",
  "filter_clause": "",
  "aggregate_field": "PERCENTILE(TimeFromRefToEndRP,0.90)",
  "aggregate_function": produce_agg_df,
  "numerator_id": "MHS133",
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "median",
  "suppression": "percent",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
}

# COMMAND ----------

cyp_out_measure_ids = {
'MHS110' : {
  'freq': 'M',
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts',  
  'source_table': 'cyp_master',     
  "filter_clause": "",
  'aggregate_field': "COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS110',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS111' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and any assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                       
  'aggregate_field': "COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_ANY = 1 THEN UniqServReqID ELSE NULL END)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS111',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS111a' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and any assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': "ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_ANY = 1 THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS111',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS111b' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                       
  'aggregate_field': "COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_SR IS NOT NULL THEN UniqServReqID ELSE NULL END)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS111b',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS111c' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': "ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_SR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS111b',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS111d' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                       
  'aggregate_field': "COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_PR IS NOT NULL THEN UniqServReqID ELSE NULL END)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS111d',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS111e' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': "ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_PR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS111d',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS111f' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                       
  'aggregate_field': "COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_CR IS NOT NULL THEN UniqServReqID ELSE NULL END)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS111f',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS111g' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective assessment',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': "ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Assessment_CR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS111f',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS112' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and any perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Paired_ANY = 1 THEN UniqServReqID ELSE NULL END)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS112',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS112a' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and any perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Paired_ANY = 1 THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS112',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS112b' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "COUNT(DISTINCT CASE WHEN Paired_SR IS NOT NULL THEN UniqServReqID ELSE NULL END)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS112b',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
}, 
'MHS112c' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Paired_SR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS112b',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS112d' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "COUNT(DISTINCT CASE WHEN Paired_PR IS NOT NULL THEN UniqServReqID ELSE NULL END)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS112d',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
}, 
'MHS112e' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Paired_PR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS112d',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS112f' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "COUNT(DISTINCT CASE WHEN Paired_CR IS NOT NULL THEN UniqServReqID ELSE NULL END)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS112f',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
}, 
'MHS112g' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "ROUND((COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL AND Paired_CR IS NOT NULL THEN UniqServReqID ELSE NULL END)/COUNT(DISTINCT CASE WHEN Contact2 IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS112f',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS113a' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "SUM(COALESCE(Improvement_SR,0))",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS113a',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS113b' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': "ROUND((SUM(COALESCE(Improvement_SR,0))/COUNT(DISTINCT CASE WHEN Paired_SR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS113a',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
}, 
'MHS113c' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                             
  'aggregate_field': "SUM(COALESCE(Deter_SR,0))",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS113c',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS113d' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "ROUND((SUM(COALESCE(Deter_SR,0))/COUNT(DISTINCT CASE WHEN Paired_SR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS113c',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS113e' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "SUM(COALESCE(NoChange_SR,0))",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS113e',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS113f' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a self-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "ROUND((SUM(COALESCE(NoChange_SR,0))/COUNT(DISTINCT CASE WHEN Paired_SR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS113e',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
}, 
'MHS114a' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "SUM(COALESCE(Improvement_PR,0))",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS114a',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': "count",
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS114b' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "ROUND((SUM(COALESCE(Improvement_PR,0))/COUNT(DISTINCT CASE WHEN Paired_PR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS114a',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
}, 
'MHS114c' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "SUM(COALESCE(Deter_PR,0))",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS114c',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS114d' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "ROUND((SUM(COALESCE(Deter_PR,0))/COUNT(DISTINCT CASE WHEN Paired_PR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS114c',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS114e' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': "SUM(COALESCE(NoChange_PR,0))",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS114e',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS114f' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a parent-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',
  "filter_clause": "",                
  'date_column': 'ReportingPeriodStartDate',                              
  'aggregate_field': "ROUND((SUM(COALESCE(NoChange_PR,0))/COUNT(DISTINCT CASE WHEN Paired_PR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS114e',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
}, 
'MHS115a' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "SUM(COALESCE(Improvement_CR,0))",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS115a',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS115b' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed measurable improvement',
  'freq': 'M',
  'source_table': 'cyp_master',       
  "filter_clause": "",                    
  'date_column': 'ReportingPeriodStartDate',                              
  'aggregate_field': "ROUND((SUM(COALESCE(Improvement_CR,0))/COUNT(DISTINCT CASE WHEN Paired_CR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS115a',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
}, 
'MHS115c' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',       
  "filter_clause": "",                    
  'date_column': 'ReportingPeriodStartDate',                              
  'aggregate_field': "SUM(COALESCE(Deter_CR,0))",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS115c',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS115d' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed measurable deterioration',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "ROUND((SUM(COALESCE(Deter_CR,0))/COUNT(DISTINCT CASE WHEN Paired_CR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS115c',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS115e' : {
  'name': 'Number of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                            
  'aggregate_field': "SUM(COALESCE(NoChange_CR,0))",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS115e',
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'count',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
'MHS115f' : {
  'name': 'Percentage of closed referrals for children and young people aged between 0 and 17 with at least 2 contacts and a clinician-rated perspective paired score that showed no measurable change',
  'freq': 'M',
  'source_table': 'cyp_master',                    
  "filter_clause": "",                              
  'aggregate_field': "ROUND((SUM(COALESCE(NoChange_CR,0))/COUNT(DISTINCT CASE WHEN Paired_CR IS NOT NULL THEN UniqServReqID ELSE NULL END))*100, 1)",
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS115e',
  "denominator": 1,  
  "crude_rate": 0,
  "related_to": "referrals",
  'suppression': 'percent',
  'breakdowns': [eng_bd, prov_bd, stp_prac_res_bd, comm_region_bd],
  "output_table": "bbrb_final_raw"
},
}

# COMMAND ----------

ips_measure_ids = {
'MHS116' : {
  'name': 'Number of referrals that accessed Individual Placement Support (IPS) in the reporting period',
  'freq': '12M',
  'source_table': 'ips_master',                                
  'aggregate_field': "COUNT(DISTINCT CASE WHEN AccessFlag = 1 THEN UniqServReqID ELSE NULL END)",
  'filter_clause': '',
  'aggregate_function': produce_agg_df,
  'numerator_id': 'MHS116', 
  'denominator': 0,
  'crude_rate': 0,
  'related_to': 'referrals',
  'suppression': 'count',
  'breakdowns': [eng_bd, age_band_ips_bd, gender_bd, upper_eth_bd, imd_decile_bd, prov_bd, ccg_prac_res_bd],
  'output_table': 'bbrb_final_raw'
},
'MHS116a' : {
  'name': 'Rate of referrals that accessed Individual Placement Support (IPS) in the reporting period per 100,000 of the population',
  'freq': '12M',
  'source_table': 'ips_master_rates',                                  
  'filter_clause': '',
  'aggregate_field': "(COALESCE(SUM(NUMERATOR_COUNT)/SUM(DENOMINATOR_COUNT), 0))*100000",
  'aggregate_function': produce_crude_rate_agg_df,
  'numerator_id': 'MHS116',  
  'denominator': 'MHSPOPALL',
  'crude_rate': 1,
  'related_to': 'referrals',
  'suppression': 'percent',
  'breakdowns': [eng_bd, age_band_ips_bd, gender_bd, upper_eth_bd, imd_decile_bd, ccg_prac_res_bd],
  'output_table': 'bbrb_final_raw'
}
}

# COMMAND ----------

uec_measure_ids = {
"CCR70": {
  "freq": "M", 
  "name": "New Emergency Referrals to Crisis Care teams in the reporting period",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "1"),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR70",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR70a": {
  "freq": "M", 
  "name": "New Emergency Referrals to Crisis Care teams in the reporting period, Aged 18 and over",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "1") & (F.col("AGE_GROUP") == "18 and over"),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR70a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR70b": {
  "freq": "M", 
  "name": "New Emergency Referrals to Crisis Care teams in the reporting period, Aged under 18",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "1") & (F.col("AGE_GROUP") == "0-17"),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR70b",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR117": {
  "freq": "M", 
  "name": "New Very Urgent Referrals to Crisis Care teams in the reporting period",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "4"),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR117",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR117a": {
  "freq": "M", 
  "name": "New Very Urgent Referrals to Crisis Care teams in the reporting period, Aged 18 and over",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "4") & (F.col("AGE_GROUP") == "18 and over"),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR117a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR117b": {
  "freq": "M", 
  "name": "New Very Urgent Referrals to Crisis Care teams in the reporting period, Aged under 18",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "4") & (F.col("AGE_GROUP") == "0-17"),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR117b",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR71": {
  "freq": "M", 
  "name": "New Urgent Referrals to Crisis Care teams in the reporting period",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "2"),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR71",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR71a": {
  "freq": "M", 
  "name": "New Urgent Referrals to Crisis Care teams in the reporting period, Aged 18 and over",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "2") & (F.col("AGE_GROUP") == "18 and over"),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR71a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR71b": {
  "freq": "M", 
  "name": "New Urgent Referrals to Crisis Care teams in the reporting period, Aged under 18",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "2") & (F.col("AGE_GROUP") == "0-17"),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR71b",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR118": {
  "freq": "M", 
  "name": "New Very Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "4") & (F.col("UniqCareContID").isNotNull()),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR118",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR118a": {
  "freq": "M", 
  "name": "New Very Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact, Aged 18 and over",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "4") & (F.col("AGE_GROUP") == "18 and over") & (F.col("UniqCareContID").isNotNull()),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR118a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR118b": {
  "freq": "M", 
  "name": "New Very Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact, Aged under 18",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "4") & (F.col("AGE_GROUP") == "0-17") & (F.col("UniqCareContID").isNotNull()),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR118b",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR73": {
  "freq": "M", 
  "name": "New Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "2") & (F.col("UniqCareContID").isNotNull()),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR73",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR73a": {
  "freq": "M", 
  "name": "New Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact, Aged 18 and over",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "2") & (F.col("AGE_GROUP") == "18 and over") & (F.col("UniqCareContID").isNotNull()),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR73a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR73b": {
  "freq": "M", 
  "name": "New Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact, Aged under 18",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "2") & (F.col("AGE_GROUP") == "0-17") & (F.col("UniqCareContID").isNotNull()),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR73b",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR119": {
  "freq": "M", 
  "name": "New Very Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact within 4 hours of referral",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "4") & (F.col("UniqCareContID").isNotNull()) & (F.col("minutes_between_ref_and_first_cont").between(0,240)),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR119",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR119a": {
  "freq": "M", 
  "name": "New Very Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact within 4 hours of referral, Aged 18 and over",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "4") & (F.col("AGE_GROUP") == "18 and over") & (F.col("UniqCareContID").isNotNull()) & (F.col("minutes_between_ref_and_first_cont").between(0,240)),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR119a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR119b": {
  "freq": "M", 
  "name": "New Very Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact within 4 hours of referral, Aged under 18",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "4") & (F.col("AGE_GROUP") == "0-17") & (F.col("UniqCareContID").isNotNull()) & (F.col("minutes_between_ref_and_first_cont").between(0,240)),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR119b",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR120": {
  "freq": "M", 
  "name": "New Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact within 24 hours of referral",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "2") & (F.col("UniqCareContID").isNotNull()) & (F.col("minutes_between_ref_and_first_cont").between(0,1440)),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR120",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR120a": {
  "freq": "M", 
  "name": "New Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact within 24 hours of referral, Aged 18 and over",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "2") & (F.col("AGE_GROUP") == "18 and over") & (F.col("UniqCareContID").isNotNull()) & (F.col("minutes_between_ref_and_first_cont").between(0,1440)),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR120a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"CCR120b": {
  "freq": "M", 
  "name": "New Urgent Referrals to Crisis Care teams in the reporting period with first face to face contact within 24 hours of referral, Aged under 18",
  "source_table": "community_crisis_master",
  "filter_clause": (F.col("ClinRespPriorityType") == "2") & (F.col("AGE_GROUP") == "0-17") & (F.col("UniqCareContID").isNotNull()) & (F.col("minutes_between_ref_and_first_cont").between(0,1440)),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "CCR120b",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"PLS121": {
  "freq": "M", 
  "name": "New referrals to liaison psychiatry teams from A&E in the reporting period",
  "source_table": "liason_psychiatry_master",
  "filter_clause": (F.col("UniqServReqID").isNotNull()),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "PLS121",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"PLS121a": {
  "freq": "M", 
  "name": "New referrals to liaison psychiatry teams from A&E in the reporting period, Aged 18 and over",
  "source_table": "liason_psychiatry_master",
  "filter_clause": (F.col("AGE_GROUP") == "18 and over"),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "PLS121a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"PLS121b": {
  "freq": "M", 
  "name": "New referrals to liaison psychiatry teams from A&E in the reporting period, Aged under 18",
  "source_table": "liason_psychiatry_master",
  "filter_clause": (F.col("AGE_GROUP") == "0-17"),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "PLS121b",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"PLS122": {
  "freq": "M", 
  "name": "New referrals to liaison psychiatry teams from A&E in the reporting period with first face to face contact",
  "source_table": "liason_psychiatry_master",
  "filter_clause": (F.col("UniqCareContID").isNotNull()),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "PLS122",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
 "PLS122a": {
  "freq": "M", 
  "name": "New referrals to liaison psychiatry teams from A&E in the reporting period with first face to face contact, Aged 18 and over",
  "source_table": "liason_psychiatry_master",
  "filter_clause": (F.col("AGE_GROUP") == "18 and over") & (F.col("UniqCareContID").isNotNull()),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "PLS122a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"PLS122b": {
  "freq": "M", 
  "name": "New referrals to liaison psychiatry teams from A&E in the reporting period with first face to face contact, Aged under 18",
  "source_table": "liason_psychiatry_master",
  "filter_clause": (F.col("AGE_GROUP") == "0-17") & (F.col("UniqCareContID").isNotNull()),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "PLS122b",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"PLS123": {
  "freq": "M", 
  "name": "New referrals to liaison psychiatry teams from A&E in the reporting period with first face to face contact within 1 hour",
  "source_table": "liason_psychiatry_master",
  "filter_clause": (F.col("UniqCareContID").isNotNull()) & (F.col("minutes_between_ref_and_first_cont").between(0,60)),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "PLS123",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"PLS123a": {
  "freq": "M", 
  "name": "New referrals to liaison psychiatry teams from A&E in the reporting period with first face to face contact within 1 hour, Aged 18 and over",
  "source_table": "liason_psychiatry_master",
  "filter_clause": (F.col("AGE_GROUP") == "18 and over") & (F.col("UniqCareContID").isNotNull()) & (F.col("minutes_between_ref_and_first_cont").between(0,60)),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "PLS123a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
},
"PLS123b": {
  "freq": "M", 
  "name": "New referrals to liaison psychiatry teams from A&E in the reporting period with first face to face contact within 1 hour, Aged under 18",
  "source_table": "liason_psychiatry_master",
  "filter_clause": (F.col("AGE_GROUP") == "0-17") & (F.col("UniqCareContID").isNotNull()) & (F.col("minutes_between_ref_and_first_cont").between(0,60)),
  "aggregate_field": "CAST(COUNT(DISTINCT UniqServReqID) as INT)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "PLS123b",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, prov_bd, ccg_prac_res_bd],
  "output_table": "bbrb_final_raw"
}
}

# COMMAND ----------

oaps_measure_ids = {
  "OAP01M": {
  "freq": "M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) started in the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Received_In_RP") == 1),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP01",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, start_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_start_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
  "OAP01Q": {
  "freq": "Q", 
  "name": "Number of Inappropriate OAPs (not bed-nights) started in the period",
  "source_table": "oaps_quarter",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Received_In_RP") == 1),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP01",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, start_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_start_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
  "OAP01Y": {
  "freq": "12M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) started in the period",
  "source_table": "oaps_year",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Received_In_RP") == 1),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP01",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, start_bed_type_bd, 
                 ccg_prac_res_bd, ccg_prac_res_age_band_oaps_bd, ccg_prac_res_lower_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_decile_bd, ccg_prac_res_reason_for_ref_bd, ccg_prac_res_start_bed_type_bd, ccg_prac_res_receiving_prov_bd,
                 stp_prac_res_bd, stp_prac_res_age_band_oaps_bd, stp_prac_res_lower_eth_bd, stp_prac_res_gender_bd, stp_prac_res_imd_decile_bd, stp_prac_res_reason_for_ref_bd, stp_prac_res_start_bed_type_bd, stp_prac_res_receiving_prov_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_start_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_age_band_oaps_bd, sending_prov_lower_eth_bd, sending_prov_gender_bd, sending_prov_imd_decile_bd, sending_prov_reason_for_ref_bd, sending_prov_start_bed_type_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd, receiving_prov_age_band_oaps_bd, receiving_prov_lower_eth_bd, receiving_prov_gender_bd, receiving_prov_imd_decile_bd, receiving_prov_reason_for_ref_bd, receiving_prov_start_bed_type_bd
                ],
  "output_table": "bbrb_final_raw"
},
"OAP01aM": {
  "freq": "M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) in Adult Acute beds started in the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Received_In_RP") == 1) & (F.col("StartAcute_Bed") == "Y"),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP01a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, start_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_start_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
  "OAP01aQ": {
  "freq": "Q", 
  "name": "Number of Inappropriate OAPs (not bed-nights) in Adult Acute beds  started in the period",
  "source_table": "oaps_quarter",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Received_In_RP") == 1) & (F.col("StartAcute_Bed") == "Y"),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP01a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, start_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_start_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
  "OAP01aY": {
  "freq": "12M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) in Adult Acute beds  started in the period",
  "source_table": "oaps_year",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Received_In_RP") == 1) & (F.col("StartAcute_Bed") == "Y"),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP01a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, start_bed_type_bd, 
                 ccg_prac_res_bd, ccg_prac_res_age_band_oaps_bd, ccg_prac_res_lower_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_decile_bd, ccg_prac_res_reason_for_ref_bd, ccg_prac_res_start_bed_type_bd, ccg_prac_res_receiving_prov_bd,
                 stp_prac_res_bd, stp_prac_res_age_band_oaps_bd, stp_prac_res_lower_eth_bd, stp_prac_res_gender_bd, stp_prac_res_imd_decile_bd, stp_prac_res_reason_for_ref_bd, stp_prac_res_start_bed_type_bd, stp_prac_res_receiving_prov_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_start_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_age_band_oaps_bd, sending_prov_lower_eth_bd, sending_prov_gender_bd, sending_prov_imd_decile_bd, sending_prov_reason_for_ref_bd, sending_prov_start_bed_type_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd, receiving_prov_age_band_oaps_bd, receiving_prov_lower_eth_bd, receiving_prov_gender_bd, receiving_prov_imd_decile_bd, receiving_prov_reason_for_ref_bd, receiving_prov_start_bed_type_bd
                ],
  "output_table": "bbrb_final_raw"
},
  "OAP02M": {
  "freq": "M", 
  "name": "Number of Inappropriate OAPs bed days in the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Submitted_In_RP") == 1) & (F.col("RANK") == 1),
  "aggregate_field": "SUM(Bed_Days_Month_HS)",
  "aggregate_function": produce_filter_oaps_bed_days_agg_df,
  "numerator_id": "OAP02",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "bed days",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP02Q": {
  "freq": "Q", 
  "name": "Number of Inappropriate OAPs bed days in the period",
  "source_table": "oaps_quarter",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Submitted_In_RP") == 1) & (F.col("RANK") == 1),
  "aggregate_field": "SUM(Bed_Days_Qtr_HS)",
  "aggregate_function": produce_filter_oaps_bed_days_agg_df,
  "numerator_id": "OAP02",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "bed days",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP02Y": {
  "freq": "12M", 
  "name": "Number of Inappropriate OAPs bed days in the period",
  "source_table": "oaps_year",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Submitted_In_RP") == 1) & (F.col("RANK") == 1),
  "aggregate_field": "SUM(Bed_Days_Yr_HS)",
  "aggregate_function": produce_filter_oaps_bed_days_agg_df,
  "numerator_id": "OAP02",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "bed days",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, bed_type_bd, 
                 ccg_prac_res_bd, ccg_prac_res_age_band_oaps_bd, ccg_prac_res_lower_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_decile_bd, ccg_prac_res_reason_for_ref_bd, ccg_prac_res_bed_type_bd, ccg_prac_res_receiving_prov_bd,
                 stp_prac_res_bd, stp_prac_res_age_band_oaps_bd, stp_prac_res_lower_eth_bd, stp_prac_res_gender_bd, stp_prac_res_imd_decile_bd, stp_prac_res_reason_for_ref_bd, stp_prac_res_bed_type_bd, stp_prac_res_receiving_prov_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_age_band_oaps_bd, sending_prov_lower_eth_bd, sending_prov_gender_bd, sending_prov_imd_decile_bd, sending_prov_reason_for_ref_bd, sending_prov_bed_type_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd, receiving_prov_age_band_oaps_bd, receiving_prov_lower_eth_bd, receiving_prov_gender_bd, receiving_prov_imd_decile_bd, receiving_prov_reason_for_ref_bd, receiving_prov_bed_type_bd
                ],
  "output_table": "bbrb_final_raw"
},
  "OAP02aM": {
  "freq": "M", 
  "name": "Number of Inappropriate OAPs bed days in Adult Acute beds in the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Submitted_In_RP") == 1) & (F.col("RANK") == 1) & (F.col("Acute_Bed") == "Y"),
  "aggregate_field": "SUM(Bed_Days_Month_HS)",
  "aggregate_function": produce_filter_oaps_bed_days_agg_df,
  "numerator_id": "OAP02a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "bed days",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP02aQ": {
  "freq": "Q", 
  "name": "Number of Inappropriate OAPs bed days in Adult Acute beds in the period",
  "source_table": "oaps_quarter",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Submitted_In_RP") == 1) & (F.col("RANK") == 1) & (F.col("Acute_Bed") == "Y"),
  "aggregate_field": "SUM(Bed_Days_Qtr_HS)",
  "aggregate_function": produce_filter_oaps_bed_days_agg_df,
  "numerator_id": "OAP02a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "bed days",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP02aY": {
  "freq": "12M", 
  "name": "Number of Inappropriate OAPs bed days in Adult Acute beds in the period",
  "source_table": "oaps_year",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Submitted_In_RP") == 1) & (F.col("RANK") == 1) & (F.col("Acute_Bed") == "Y"),
  "aggregate_field": "SUM(Bed_Days_Yr_HS)",
  "aggregate_function": produce_filter_oaps_bed_days_agg_df,
  "numerator_id": "OAP02a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "bed days",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, bed_type_bd, 
                 ccg_prac_res_bd, ccg_prac_res_age_band_oaps_bd, ccg_prac_res_lower_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_decile_bd, ccg_prac_res_reason_for_ref_bd, ccg_prac_res_bed_type_bd, ccg_prac_res_receiving_prov_bd,
                 stp_prac_res_bd, stp_prac_res_age_band_oaps_bd, stp_prac_res_lower_eth_bd, stp_prac_res_gender_bd, stp_prac_res_imd_decile_bd, stp_prac_res_reason_for_ref_bd, stp_prac_res_bed_type_bd, stp_prac_res_receiving_prov_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_age_band_oaps_bd, sending_prov_lower_eth_bd, sending_prov_gender_bd, sending_prov_imd_decile_bd, sending_prov_reason_for_ref_bd, sending_prov_bed_type_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd, receiving_prov_age_band_oaps_bd, receiving_prov_lower_eth_bd, receiving_prov_gender_bd, receiving_prov_imd_decile_bd, receiving_prov_reason_for_ref_bd, receiving_prov_bed_type_bd
                ],
  "output_table": "bbrb_final_raw"
},
  "OAP03M": {
  "freq": "M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) active at the end of the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Active_End") == 1),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP03",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, active_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_active_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP03Q": {
  "freq": "Q", 
  "name": "Number of Inappropriate OAPs (not bed-nights) active at the end of the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Active_End") == 1),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP03",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, active_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_active_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP03Y": {
  "freq": "12M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) active at the end of the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Active_End") == 1),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP03",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, active_bed_type_bd, 
                 ccg_prac_res_bd, ccg_prac_res_age_band_oaps_bd, ccg_prac_res_lower_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_decile_bd, ccg_prac_res_reason_for_ref_bd, ccg_prac_res_active_bed_type_bd, ccg_prac_res_receiving_prov_bd,
                 stp_prac_res_bd, stp_prac_res_age_band_oaps_bd, stp_prac_res_lower_eth_bd, stp_prac_res_gender_bd, stp_prac_res_imd_decile_bd, stp_prac_res_reason_for_ref_bd, stp_prac_res_active_bed_type_bd, stp_prac_res_receiving_prov_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_active_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_age_band_oaps_bd, sending_prov_lower_eth_bd, sending_prov_gender_bd, sending_prov_imd_decile_bd, sending_prov_reason_for_ref_bd, sending_prov_active_bed_type_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd, receiving_prov_age_band_oaps_bd, receiving_prov_lower_eth_bd, receiving_prov_gender_bd, receiving_prov_imd_decile_bd, receiving_prov_reason_for_ref_bd, receiving_prov_active_bed_type_bd
                ],
  "output_table": "bbrb_final_raw"
},
  "OAP03aM": {
  "freq": "M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) in Adult Acute beds active at the end of the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Active_End") == 1)  & (F.col("ActiveAcute_Bed") == "Y"),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP03a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, active_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_active_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP03aQ": {
  "freq": "Q", 
  "name": "Number of Inappropriate OAPs (not bed-nights) in Adult Acute beds active at the end of the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Active_End") == 1) & (F.col("ActiveAcute_Bed") == "Y"),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP03a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, active_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_active_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP03aY": {
  "freq": "12M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) in Adult Acute beds active at the end of the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Active_End") == 1) & (F.col("ActiveAcute_Bed") == "Y"),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP03a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, active_bed_type_bd, 
                 ccg_prac_res_bd, ccg_prac_res_age_band_oaps_bd, ccg_prac_res_lower_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_decile_bd, ccg_prac_res_reason_for_ref_bd, ccg_prac_res_active_bed_type_bd, ccg_prac_res_receiving_prov_bd,
                 stp_prac_res_bd, stp_prac_res_age_band_oaps_bd, stp_prac_res_lower_eth_bd, stp_prac_res_gender_bd, stp_prac_res_imd_decile_bd, stp_prac_res_reason_for_ref_bd, stp_prac_res_active_bed_type_bd, stp_prac_res_receiving_prov_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_active_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_age_band_oaps_bd, sending_prov_lower_eth_bd, sending_prov_gender_bd, sending_prov_imd_decile_bd, sending_prov_reason_for_ref_bd, sending_prov_active_bed_type_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd, receiving_prov_age_band_oaps_bd, receiving_prov_lower_eth_bd, receiving_prov_gender_bd, receiving_prov_imd_decile_bd, receiving_prov_reason_for_ref_bd, receiving_prov_active_bed_type_bd
                ],
  "output_table": "bbrb_final_raw"
},
  "OAP04M": {
  "freq": "M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) ended in the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Ended_In_RP") == 1) & (F.col("Submitted_In_RP") == 1),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP04",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, end_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_end_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP04Q": {
  "freq": "Q", 
  "name": "Number of Inappropriate OAPs (not bed-nights) ended in the period",
  "source_table": "oaps_quarter",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Ended_In_RP") == 1) & (F.col("Submitted_In_RP") == 1),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP04",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, end_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_end_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP04Y": {
  "freq": "12M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) ended in the period",
  "source_table": "oaps_year",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Ended_In_RP") == 1) & (F.col("Submitted_In_RP") == 1),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP04",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, end_bed_type_bd, 
                 ccg_prac_res_bd, ccg_prac_res_age_band_oaps_bd, ccg_prac_res_lower_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_decile_bd, ccg_prac_res_reason_for_ref_bd, ccg_prac_res_end_bed_type_bd, ccg_prac_res_receiving_prov_bd,
                 stp_prac_res_bd, stp_prac_res_age_band_oaps_bd, stp_prac_res_lower_eth_bd, stp_prac_res_gender_bd, stp_prac_res_imd_decile_bd, stp_prac_res_reason_for_ref_bd, stp_prac_res_end_bed_type_bd, stp_prac_res_receiving_prov_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_end_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_age_band_oaps_bd, sending_prov_lower_eth_bd, sending_prov_gender_bd, sending_prov_imd_decile_bd, sending_prov_reason_for_ref_bd, sending_prov_end_bed_type_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd, receiving_prov_age_band_oaps_bd, receiving_prov_lower_eth_bd, receiving_prov_gender_bd, receiving_prov_imd_decile_bd, receiving_prov_reason_for_ref_bd, receiving_prov_end_bed_type_bd
                ],
  "output_table": "bbrb_final_raw"
},
  "OAP04aM": {
  "freq": "M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) in Adult Acute beds ended in the period",
  "source_table": "oaps_month",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Ended_In_RP") == 1) & (F.col("Submitted_In_RP") == 1) & (F.col("EndAcute_Bed") == "Y"),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP04a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, end_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_end_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP04aQ": {
  "freq": "Q", 
  "name": "Number of Inappropriate OAPs (not bed-nights) in Adult Acute beds ended in the period",
  "source_table": "oaps_quarter",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Ended_In_RP") == 1) & (F.col("Submitted_In_RP") == 1) & (F.col("EndAcute_Bed") == "Y"),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP04a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, end_bed_type_bd, 
                 ccg_prac_res_bd, 
                 stp_prac_res_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_end_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd
                ],
  "output_table": "bbrb_final_raw"
},
 "OAP04aY": {
  "freq": "12M", 
  "name": "Number of Inappropriate OAPs (not bed-nights) in Adult Acute beds ended in the period",
  "source_table": "oaps_year",
  "filter_clause": (F.col("ReasonOAT") == "10") & (F.col("Ended_In_RP") == 1) & (F.col("Submitted_In_RP") == 1) & (F.col("EndAcute_Bed") == "Y"),
  "aggregate_field": "COUNT(DISTINCT UniqServReqID)",
  "aggregate_function": produce_filter_agg_df,
  "numerator_id": "OAP04a",
  "denominator": 0,  
  "crude_rate": 0,
  "related_to": "referrals",
  "suppression": "count",
  "breakdowns": [eng_bd, age_band_oaps_bd, lower_eth_bd, gender_bd, imd_decile_bd, reason_for_ref_bd, end_bed_type_bd, 
                 ccg_prac_res_bd, ccg_prac_res_age_band_oaps_bd, ccg_prac_res_lower_eth_bd, ccg_prac_res_gender_bd, ccg_prac_res_imd_decile_bd, ccg_prac_res_reason_for_ref_bd, ccg_prac_res_end_bed_type_bd, ccg_prac_res_receiving_prov_bd,
                 stp_prac_res_bd, stp_prac_res_age_band_oaps_bd, stp_prac_res_lower_eth_bd, stp_prac_res_gender_bd, stp_prac_res_imd_decile_bd, stp_prac_res_reason_for_ref_bd, stp_prac_res_end_bed_type_bd, stp_prac_res_receiving_prov_bd,
                 comm_region_bd, comm_region_age_band_oaps_bd, comm_region_lower_eth_bd, comm_region_gender_bd, comm_region_imd_decile_bd, comm_region_reason_for_ref_bd, comm_region_end_bed_type_bd, comm_region_receiving_prov_bd,
                 sending_prov_bd, sending_prov_age_band_oaps_bd, sending_prov_lower_eth_bd, sending_prov_gender_bd, sending_prov_imd_decile_bd, sending_prov_reason_for_ref_bd, sending_prov_end_bed_type_bd, sending_prov_receiving_prov_bd,
                 receiving_prov_bd, receiving_prov_age_band_oaps_bd, receiving_prov_lower_eth_bd, receiving_prov_gender_bd, receiving_prov_imd_decile_bd, receiving_prov_reason_for_ref_bd, receiving_prov_end_bed_type_bd
                ],
  "output_table": "bbrb_final_raw"
}
}

# COMMAND ----------

# DBTITLE 1,Combine Dictionaries into one:
measure_metadata = {
  "ALL": {**los_measure_ids, **four_ww_measure_ids, **cmh_measure_ids, **cyp_peri_measure_ids, **cyp_out_measure_ids, **uec_measure_ids, **ips_measure_ids, **oaps_measure_ids},
  "01_LOS": los_measure_ids,
  "02_4W_WAITS": four_ww_measure_ids,
  "03_CMH": cmh_measure_ids,
  "04_CYP": cyp_peri_measure_ids,
  "05_CYP_OUTCOMES": cyp_out_measure_ids,  
  "06_IPS": ips_measure_ids,
  "07_UEC": uec_measure_ids,
  "08_OAPS": oaps_measure_ids
}