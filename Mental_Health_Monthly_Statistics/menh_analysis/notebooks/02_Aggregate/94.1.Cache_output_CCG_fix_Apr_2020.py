# Databricks notebook source
 %md

 # Collect and cache newly computed data in "all_products_cached"

# COMMAND ----------

 %md

 ## This is an alternative notebook that will run only for a couple of months to sort out an issue in the reference data where old CCGs are coming through

# COMMAND ----------

# DBTITLE 1,1. Update CCGs for Main Monthly
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW Main_monthly_expanded_Apr20_map AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN,  

 case when PRIMARY_LEVEL in ('00C','00K','00M') THEN '16C'
 when PRIMARY_LEVEL in ('05F','05J','05T','06D') THEN '18C'
 when PRIMARY_LEVEL in ('06M','06V','06W','06Y','07J') THEN '26A'
 when PRIMARY_LEVEL in ('01C','01R','02D','02F') THEN '27D'
 when PRIMARY_LEVEL in ('02N','02W','02R') THEN '36J'
 when PRIMARY_LEVEL in ('07V','08J','08R','08P','08T','08X') THEN '36L'
 when PRIMARY_LEVEL in ('03D','03E','03M') THEN '42D'
 when PRIMARY_LEVEL in ('04E','04H','04K','04L','04M','04N') THEN '52R'
 when PRIMARY_LEVEL in ('09G','09H','09X') THEN '70F'
 when PRIMARY_LEVEL in ('03T','04D','99D','04Q') THEN '71E'
 when PRIMARY_LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN '72Q'
 when PRIMARY_LEVEL in ('03V','04G') THEN '78H'
 when PRIMARY_LEVEL in ('00D','00J') THEN '84H'
 when PRIMARY_LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN '91Q'
 when PRIMARY_LEVEL in ('09L','09N','09Y','99H') THEN '92A'
 when PRIMARY_LEVEL in ('11E','12D','99N') THEN '92G'
 when PRIMARY_LEVEL in ('07M','07R','07X','08D','08H') THEN '93C'
 when PRIMARY_LEVEL in ('09F','09P','99K') THEN '97R'
 ELSE PRIMARY_LEVEL
 END AS PRIMARY_LEVEL_FIXED,

 case when PRIMARY_LEVEL in ('00C','00K','00M') THEN 'NHS TEES VALLEY CCG'
 when PRIMARY_LEVEL in ('05F','05J','05T','06D') THEN 'NHS HEREFORDSHIRE AND WORCESTERSHIRE CCG'
 when PRIMARY_LEVEL in ('06M','06V','06W','06Y','07J') THEN 'NHS NORFOLK AND WAVENEY CCG'
 when PRIMARY_LEVEL in ('01C','01R','02D','02F') THEN 'NHS CHESHIRE CCG'
 when PRIMARY_LEVEL in ('02N','02W','02R') THEN 'NHS BRADFORD DISTRICT AND CRAVEN CCG'
 when PRIMARY_LEVEL in ('07V','08J','08R','08P','08T','08X') THEN 'NHS SOUTH WEST LONDON CCG'
 when PRIMARY_LEVEL in ('03D','03E','03M') THEN 'NHS NORTH YORKSHIRE CCG'
 when PRIMARY_LEVEL in ('04E','04H','04K','04L','04M','04N') THEN 'NHS NOTTINGHAM AND NOTTINGHAMSHIRE CCG'
 when PRIMARY_LEVEL in ('09G','09H','09X') THEN 'NHS WEST SUSSEX CCG'
 when PRIMARY_LEVEL in ('03T','04D','99D','04Q') THEN 'NHS LINCOLNSHIRE CCG'
 when PRIMARY_LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN 'NHS SOUTH EAST LONDON CCG'
 when PRIMARY_LEVEL in ('03V','04G') THEN 'NHS NORTHAMPTONSHIRE CCG'
 when PRIMARY_LEVEL in ('00D','00J') THEN 'NHS COUNTY DURHAM CCG'
 when PRIMARY_LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN 'NHS KENT AND MEDWAY CCG'
 when PRIMARY_LEVEL in ('09L','09N','09Y','99H') THEN 'NHS SURREY HEARTLANDS CCG'
 when PRIMARY_LEVEL in ('11E','12D','99N') THEN 'NHS BATH AND NORTH EAST SOMERSET, SWINDON AND WILTSHIRE CCG'
 when PRIMARY_LEVEL in ('07M','07R','07X','08D','08H') THEN 'NHS NORTH CENTRAL LONDON CCG'
 when PRIMARY_LEVEL in ('09F','09P','99K') THEN 'NHS EAST SUSSEX CCG'
 ELSE PRIMARY_LEVEL_DESCRIPTION
 END AS PRIMARY_LEVEL_DESCRIPTION_FIXED,

 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.Main_monthly_expanded

# COMMAND ----------

# DBTITLE 1,1. Group CCGs for Main Monthly
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW Main_monthly_expanded_Apr20_group AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED AS PRIMARY_LEVEL,
 PRIMARY_LEVEL_DESCRIPTION_FIXED AS PRIMARY_LEVEL_DESCRIPTION, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SUM(METRIC_VALUE) AS METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.Main_monthly_expanded_Apr20_map
 GROUP BY 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED,
 PRIMARY_LEVEL_DESCRIPTION_FIXED, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SOURCE_DB

# COMMAND ----------

# DBTITLE 1,1. Cache Main Monthly
 %sql


 INSERT INTO $db_output.all_products_cached 
 SELECT 1 AS PRODUCT_NO, 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL,
 PRIMARY_LEVEL_DESCRIPTION, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.Main_monthly_expanded_Apr20_group

# COMMAND ----------

# DBTITLE 1,1.1 Update CCGs for Delayed Discharge (MHS26)
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW DD_expanded_Apr20_map AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN,  

 case when PRIMARY_LEVEL in ('00C','00K','00M') THEN '16C'
 when PRIMARY_LEVEL in ('05F','05J','05T','06D') THEN '18C'
 when PRIMARY_LEVEL in ('06M','06V','06W','06Y','07J') THEN '26A'
 when PRIMARY_LEVEL in ('01C','01R','02D','02F') THEN '27D'
 when PRIMARY_LEVEL in ('02N','02W','02R') THEN '36J'
 when PRIMARY_LEVEL in ('07V','08J','08R','08P','08T','08X') THEN '36L'
 when PRIMARY_LEVEL in ('03D','03E','03M') THEN '42D'
 when PRIMARY_LEVEL in ('04E','04H','04K','04L','04M','04N') THEN '52R'
 when PRIMARY_LEVEL in ('09G','09H','09X') THEN '70F'
 when PRIMARY_LEVEL in ('03T','04D','99D','04Q') THEN '71E'
 when PRIMARY_LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN '72Q'
 when PRIMARY_LEVEL in ('03V','04G') THEN '78H'
 when PRIMARY_LEVEL in ('00D','00J') THEN '84H'
 when PRIMARY_LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN '91Q'
 when PRIMARY_LEVEL in ('09L','09N','09Y','99H') THEN '92A'
 when PRIMARY_LEVEL in ('11E','12D','99N') THEN '92G'
 when PRIMARY_LEVEL in ('07M','07R','07X','08D','08H') THEN '93C'
 when PRIMARY_LEVEL in ('09F','09P','99K') THEN '97R'
 ELSE PRIMARY_LEVEL
 END AS PRIMARY_LEVEL_FIXED,

 case when PRIMARY_LEVEL in ('00C','00K','00M') THEN 'NHS TEES VALLEY CCG'
 when PRIMARY_LEVEL in ('05F','05J','05T','06D') THEN 'NHS HEREFORDSHIRE AND WORCESTERSHIRE CCG'
 when PRIMARY_LEVEL in ('06M','06V','06W','06Y','07J') THEN 'NHS NORFOLK AND WAVENEY CCG'
 when PRIMARY_LEVEL in ('01C','01R','02D','02F') THEN 'NHS CHESHIRE CCG'
 when PRIMARY_LEVEL in ('02N','02W','02R') THEN 'NHS BRADFORD DISTRICT AND CRAVEN CCG'
 when PRIMARY_LEVEL in ('07V','08J','08R','08P','08T','08X') THEN 'NHS SOUTH WEST LONDON CCG'
 when PRIMARY_LEVEL in ('03D','03E','03M') THEN 'NHS NORTH YORKSHIRE CCG'
 when PRIMARY_LEVEL in ('04E','04H','04K','04L','04M','04N') THEN 'NHS NOTTINGHAM AND NOTTINGHAMSHIRE CCG'
 when PRIMARY_LEVEL in ('09G','09H','09X') THEN 'NHS WEST SUSSEX CCG'
 when PRIMARY_LEVEL in ('03T','04D','99D','04Q') THEN 'NHS LINCOLNSHIRE CCG'
 when PRIMARY_LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN 'NHS SOUTH EAST LONDON CCG'
 when PRIMARY_LEVEL in ('03V','04G') THEN 'NHS NORTHAMPTONSHIRE CCG'
 when PRIMARY_LEVEL in ('00D','00J') THEN 'NHS COUNTY DURHAM CCG'
 when PRIMARY_LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN 'NHS KENT AND MEDWAY CCG'
 when PRIMARY_LEVEL in ('09L','09N','09Y','99H') THEN 'NHS SURREY HEARTLANDS CCG'
 when PRIMARY_LEVEL in ('11E','12D','99N') THEN 'NHS BATH AND NORTH EAST SOMERSET, SWINDON AND WILTSHIRE CCG'
 when PRIMARY_LEVEL in ('07M','07R','07X','08D','08H') THEN 'NHS NORTH CENTRAL LONDON CCG'
 when PRIMARY_LEVEL in ('09F','09P','99K') THEN 'NHS EAST SUSSEX CCG'
 ELSE PRIMARY_LEVEL_DESCRIPTION
 END AS PRIMARY_LEVEL_DESCRIPTION_FIXED,

 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.DD_expanded

# COMMAND ----------

# DBTITLE 1,1.1 Group CCGs for Delayed Discharge (MHS26)
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW DD_expanded_Apr20_group AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED AS PRIMARY_LEVEL,
 PRIMARY_LEVEL_DESCRIPTION_FIXED AS PRIMARY_LEVEL_DESCRIPTION, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SUM(METRIC_VALUE) AS METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.DD_expanded_Apr20_map
 GROUP BY 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED,
 PRIMARY_LEVEL_DESCRIPTION_FIXED, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SOURCE_DB

# COMMAND ----------

# DBTITLE 1,1.1 Cache Delayed Discharge (MHS26)
 %sql


 INSERT INTO $db_output.all_products_cached 
 SELECT 1 AS PRODUCT_NO, 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END,
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL,
 PRIMARY_LEVEL_DESCRIPTION, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 METRIC_VALUE, 
 SOURCE_DB 
 FROM global_temp.DD_expanded_Apr20_group

# COMMAND ----------

# DBTITLE 1,2. Update CCGs for AWT
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW AWT_expanded_Apr20_map AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN,  

 case when PRIMARY_LEVEL in ('00C','00K','00M') THEN '16C'
 when PRIMARY_LEVEL in ('05F','05J','05T','06D') THEN '18C'
 when PRIMARY_LEVEL in ('06M','06V','06W','06Y','07J') THEN '26A'
 when PRIMARY_LEVEL in ('01C','01R','02D','02F') THEN '27D'
 when PRIMARY_LEVEL in ('02N','02W','02R') THEN '36J'
 when PRIMARY_LEVEL in ('07V','08J','08R','08P','08T','08X') THEN '36L'
 when PRIMARY_LEVEL in ('03D','03E','03M') THEN '42D'
 when PRIMARY_LEVEL in ('04E','04H','04K','04L','04M','04N') THEN '52R'
 when PRIMARY_LEVEL in ('09G','09H','09X') THEN '70F'
 when PRIMARY_LEVEL in ('03T','04D','99D','04Q') THEN '71E'
 when PRIMARY_LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN '72Q'
 when PRIMARY_LEVEL in ('03V','04G') THEN '78H'
 when PRIMARY_LEVEL in ('00D','00J') THEN '84H'
 when PRIMARY_LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN '91Q'
 when PRIMARY_LEVEL in ('09L','09N','09Y','99H') THEN '92A'
 when PRIMARY_LEVEL in ('11E','12D','99N') THEN '92G'
 when PRIMARY_LEVEL in ('07M','07R','07X','08D','08H') THEN '93C'
 when PRIMARY_LEVEL in ('09F','09P','99K') THEN '97R'
 ELSE PRIMARY_LEVEL
 END AS PRIMARY_LEVEL_FIXED,

 case when PRIMARY_LEVEL in ('00C','00K','00M') THEN 'NHS TEES VALLEY CCG'
 when PRIMARY_LEVEL in ('05F','05J','05T','06D') THEN 'NHS HEREFORDSHIRE AND WORCESTERSHIRE CCG'
 when PRIMARY_LEVEL in ('06M','06V','06W','06Y','07J') THEN 'NHS NORFOLK AND WAVENEY CCG'
 when PRIMARY_LEVEL in ('01C','01R','02D','02F') THEN 'NHS CHESHIRE CCG'
 when PRIMARY_LEVEL in ('02N','02W','02R') THEN 'NHS BRADFORD DISTRICT AND CRAVEN CCG'
 when PRIMARY_LEVEL in ('07V','08J','08R','08P','08T','08X') THEN 'NHS SOUTH WEST LONDON CCG'
 when PRIMARY_LEVEL in ('03D','03E','03M') THEN 'NHS NORTH YORKSHIRE CCG'
 when PRIMARY_LEVEL in ('04E','04H','04K','04L','04M','04N') THEN 'NHS NOTTINGHAM AND NOTTINGHAMSHIRE CCG'
 when PRIMARY_LEVEL in ('09G','09H','09X') THEN 'NHS WEST SUSSEX CCG'
 when PRIMARY_LEVEL in ('03T','04D','99D','04Q') THEN 'NHS LINCOLNSHIRE CCG'
 when PRIMARY_LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN 'NHS SOUTH EAST LONDON CCG'
 when PRIMARY_LEVEL in ('03V','04G') THEN 'NHS NORTHAMPTONSHIRE CCG'
 when PRIMARY_LEVEL in ('00D','00J') THEN 'NHS COUNTY DURHAM CCG'
 when PRIMARY_LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN 'NHS KENT AND MEDWAY CCG'
 when PRIMARY_LEVEL in ('09L','09N','09Y','99H') THEN 'NHS SURREY HEARTLANDS CCG'
 when PRIMARY_LEVEL in ('11E','12D','99N') THEN 'NHS BATH AND NORTH EAST SOMERSET, SWINDON AND WILTSHIRE CCG'
 when PRIMARY_LEVEL in ('07M','07R','07X','08D','08H') THEN 'NHS NORTH CENTRAL LONDON CCG'
 when PRIMARY_LEVEL in ('09F','09P','99K') THEN 'NHS EAST SUSSEX CCG'
 ELSE PRIMARY_LEVEL_DESCRIPTION
 END AS PRIMARY_LEVEL_DESCRIPTION_FIXED,

 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.AWT_expanded

# COMMAND ----------

# DBTITLE 1,2. Group CCGs for AWT
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW AWT_expanded_Apr20_group AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED AS PRIMARY_LEVEL,
 PRIMARY_LEVEL_DESCRIPTION_FIXED AS PRIMARY_LEVEL_DESCRIPTION, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SUM(METRIC_VALUE) AS METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.AWT_expanded_Apr20_map
 GROUP BY 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED,
 PRIMARY_LEVEL_DESCRIPTION_FIXED, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SOURCE_DB

# COMMAND ----------

# DBTITLE 1,2.Cache AWT
 %sql

 INSERT INTO $db_output.all_products_cached
 SELECT
   2 AS PRODUCT_NO,
   REPORTING_PERIOD_START,
   REPORTING_PERIOD_END,
   STATUS,
   BREAKDOWN,
   PRIMARY_LEVEL,
   PRIMARY_LEVEL_DESCRIPTION,
   SECONDARY_LEVEL,
   SECONDARY_LEVEL_DESCRIPTION,
   METRIC,
   METRIC_NAME,
   METRIC_VALUE,
   SOURCE_DB
   --CURRENT_TIMESTAMP()
 FROM global_temp.AWT_expanded_Apr20_group

# COMMAND ----------

# DBTITLE 1,3. Update CCGs for CYP 2nd Contact
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW CYP_2nd_contact_expanded_Apr20_map AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN,  

 case when PRIMARY_LEVEL in ('00C','00K','00M') THEN '16C'
 when PRIMARY_LEVEL in ('05F','05J','05T','06D') THEN '18C'
 when PRIMARY_LEVEL in ('06M','06V','06W','06Y','07J') THEN '26A'
 when PRIMARY_LEVEL in ('01C','01R','02D','02F') THEN '27D'
 when PRIMARY_LEVEL in ('02N','02W','02R') THEN '36J'
 when PRIMARY_LEVEL in ('07V','08J','08R','08P','08T','08X') THEN '36L'
 when PRIMARY_LEVEL in ('03D','03E','03M') THEN '42D'
 when PRIMARY_LEVEL in ('04E','04H','04K','04L','04M','04N') THEN '52R'
 when PRIMARY_LEVEL in ('09G','09H','09X') THEN '70F'
 when PRIMARY_LEVEL in ('03T','04D','99D','04Q') THEN '71E'
 when PRIMARY_LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN '72Q'
 when PRIMARY_LEVEL in ('03V','04G') THEN '78H'
 when PRIMARY_LEVEL in ('00D','00J') THEN '84H'
 when PRIMARY_LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN '91Q'
 when PRIMARY_LEVEL in ('09L','09N','09Y','99H') THEN '92A'
 when PRIMARY_LEVEL in ('11E','12D','99N') THEN '92G'
 when PRIMARY_LEVEL in ('07M','07R','07X','08D','08H') THEN '93C'
 when PRIMARY_LEVEL in ('09F','09P','99K') THEN '97R'
 ELSE PRIMARY_LEVEL
 END AS PRIMARY_LEVEL_FIXED,

 case when PRIMARY_LEVEL in ('00C','00K','00M') THEN 'NHS TEES VALLEY CCG'
 when PRIMARY_LEVEL in ('05F','05J','05T','06D') THEN 'NHS HEREFORDSHIRE AND WORCESTERSHIRE CCG'
 when PRIMARY_LEVEL in ('06M','06V','06W','06Y','07J') THEN 'NHS NORFOLK AND WAVENEY CCG'
 when PRIMARY_LEVEL in ('01C','01R','02D','02F') THEN 'NHS CHESHIRE CCG'
 when PRIMARY_LEVEL in ('02N','02W','02R') THEN 'NHS BRADFORD DISTRICT AND CRAVEN CCG'
 when PRIMARY_LEVEL in ('07V','08J','08R','08P','08T','08X') THEN 'NHS SOUTH WEST LONDON CCG'
 when PRIMARY_LEVEL in ('03D','03E','03M') THEN 'NHS NORTH YORKSHIRE CCG'
 when PRIMARY_LEVEL in ('04E','04H','04K','04L','04M','04N') THEN 'NHS NOTTINGHAM AND NOTTINGHAMSHIRE CCG'
 when PRIMARY_LEVEL in ('09G','09H','09X') THEN 'NHS WEST SUSSEX CCG'
 when PRIMARY_LEVEL in ('03T','04D','99D','04Q') THEN 'NHS LINCOLNSHIRE CCG'
 when PRIMARY_LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN 'NHS SOUTH EAST LONDON CCG'
 when PRIMARY_LEVEL in ('03V','04G') THEN 'NHS NORTHAMPTONSHIRE CCG'
 when PRIMARY_LEVEL in ('00D','00J') THEN 'NHS COUNTY DURHAM CCG'
 when PRIMARY_LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN 'NHS KENT AND MEDWAY CCG'
 when PRIMARY_LEVEL in ('09L','09N','09Y','99H') THEN 'NHS SURREY HEARTLANDS CCG'
 when PRIMARY_LEVEL in ('11E','12D','99N') THEN 'NHS BATH AND NORTH EAST SOMERSET, SWINDON AND WILTSHIRE CCG'
 when PRIMARY_LEVEL in ('07M','07R','07X','08D','08H') THEN 'NHS NORTH CENTRAL LONDON CCG'
 when PRIMARY_LEVEL in ('09F','09P','99K') THEN 'NHS EAST SUSSEX CCG'
 ELSE PRIMARY_LEVEL_DESCRIPTION
 END AS PRIMARY_LEVEL_DESCRIPTION_FIXED,

 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.CYP_2nd_contact_expanded

# COMMAND ----------

# DBTITLE 1,3. Group CCGs for CYP 2nd Contact
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW CYP_2nd_contact_expanded_Apr20_group AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED AS PRIMARY_LEVEL,
 PRIMARY_LEVEL_DESCRIPTION_FIXED AS PRIMARY_LEVEL_DESCRIPTION, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SUM(METRIC_VALUE) AS METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.CYP_2nd_contact_expanded_Apr20_map
 GROUP BY 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED,
 PRIMARY_LEVEL_DESCRIPTION_FIXED, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SOURCE_DB

# COMMAND ----------

# DBTITLE 1,3.Cache CYP 2nd Contact
 %sql

 INSERT INTO $db_output.all_products_cached
 SELECT
   3 AS PRODUCT_NO,
   REPORTING_PERIOD_START,
   REPORTING_PERIOD_END,
   STATUS,
   BREAKDOWN,
   PRIMARY_LEVEL,
   PRIMARY_LEVEL_DESCRIPTION,
   SECONDARY_LEVEL,
   SECONDARY_LEVEL_DESCRIPTION,
   METRIC,
   METRIC_NAME,
   METRIC_VALUE,
   SOURCE_DB
   --CURRENT_TIMESTAMP()
 FROM global_temp.CYP_2nd_contact_expanded_Apr20_group

# COMMAND ----------

# DBTITLE 1,4. Update CCGs for CAP
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW CAP_expanded_Apr20_map AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN,  

 case when LEVEL in ('00C','00K','00M') THEN '16C'
 when LEVEL in ('05F','05J','05T','06D') THEN '18C'
 when LEVEL in ('06M','06V','06W','06Y','07J') THEN '26A'
 when LEVEL in ('01C','01R','02D','02F') THEN '27D'
 when LEVEL in ('02N','02W','02R') THEN '36J'
 when LEVEL in ('07V','08J','08R','08P','08T','08X') THEN '36L'
 when LEVEL in ('03D','03E','03M') THEN '42D'
 when LEVEL in ('04E','04H','04K','04L','04M','04N') THEN '52R'
 when LEVEL in ('09G','09H','09X') THEN '70F'
 when LEVEL in ('03T','04D','99D','04Q') THEN '71E'
 when LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN '72Q'
 when LEVEL in ('03V','04G') THEN '78H'
 when LEVEL in ('00D','00J') THEN '84H'
 when LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN '91Q'
 when LEVEL in ('09L','09N','09Y','99H') THEN '92A'
 when LEVEL in ('11E','12D','99N') THEN '92G'
 when LEVEL in ('07M','07R','07X','08D','08H') THEN '93C'
 when LEVEL in ('09F','09P','99K') THEN '97R'
 ELSE LEVEL
 END AS PRIMARY_LEVEL_FIXED,

 case when LEVEL in ('00C','00K','00M') THEN 'NHS TEES VALLEY CCG'
 when LEVEL in ('05F','05J','05T','06D') THEN 'NHS HEREFORDSHIRE AND WORCESTERSHIRE CCG'
 when LEVEL in ('06M','06V','06W','06Y','07J') THEN 'NHS NORFOLK AND WAVENEY CCG'
 when LEVEL in ('01C','01R','02D','02F') THEN 'NHS CHESHIRE CCG'
 when LEVEL in ('02N','02W','02R') THEN 'NHS BRADFORD DISTRICT AND CRAVEN CCG'
 when LEVEL in ('07V','08J','08R','08P','08T','08X') THEN 'NHS SOUTH WEST LONDON CCG'
 when LEVEL in ('03D','03E','03M') THEN 'NHS NORTH YORKSHIRE CCG'
 when LEVEL in ('04E','04H','04K','04L','04M','04N') THEN 'NHS NOTTINGHAM AND NOTTINGHAMSHIRE CCG'
 when LEVEL in ('09G','09H','09X') THEN 'NHS WEST SUSSEX CCG'
 when LEVEL in ('03T','04D','99D','04Q') THEN 'NHS LINCOLNSHIRE CCG'
 when LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN 'NHS SOUTH EAST LONDON CCG'
 when LEVEL in ('03V','04G') THEN 'NHS NORTHAMPTONSHIRE CCG'
 when LEVEL in ('00D','00J') THEN 'NHS COUNTY DURHAM CCG'
 when LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN 'NHS KENT AND MEDWAY CCG'
 when LEVEL in ('09L','09N','09Y','99H') THEN 'NHS SURREY HEARTLANDS CCG'
 when LEVEL in ('11E','12D','99N') THEN 'NHS BATH AND NORTH EAST SOMERSET, SWINDON AND WILTSHIRE CCG'
 when LEVEL in ('07M','07R','07X','08D','08H') THEN 'NHS NORTH CENTRAL LONDON CCG'
 when LEVEL in ('09F','09P','99K') THEN 'NHS EAST SUSSEX CCG'
 ELSE LEVEL_DESCRIPTION
 END AS PRIMARY_LEVEL_DESCRIPTION_FIXED,

 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.CAP_expanded

# COMMAND ----------

# DBTITLE 1,4. Group CCGs for CAP
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW CAP_expanded_Apr20_group AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED AS PRIMARY_LEVEL,
 PRIMARY_LEVEL_DESCRIPTION_FIXED AS PRIMARY_LEVEL_DESCRIPTION, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SUM(METRIC_VALUE) AS METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.CAP_expanded_Apr20_map
 GROUP BY 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED,
 PRIMARY_LEVEL_DESCRIPTION_FIXED, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SOURCE_DB

# COMMAND ----------

# DBTITLE 1,4.Cache CAP
 %sql
 --reinstated this SQL version now that the need to restrict outputs for Provisional & Final has dropped
 --also Final is now Performance anyway!

 INSERT INTO $db_output.all_products_cached 
 SELECT 
 4 AS PRODUCT_NO, 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END,
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL, 
 PRIMARY_LEVEL_DESCRIPTION, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 METRIC_VALUE, 
 SOURCE_DB 
 FROM global_temp.CAP_expanded_Apr20_group

# COMMAND ----------

# DBTITLE 1,5. Update CCGs for CYP Monthly
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW CYP_monthly_expanded_Apr20_map AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN,  

 case when PRIMARY_LEVEL in ('00C','00K','00M') THEN '16C'
 when PRIMARY_LEVEL in ('05F','05J','05T','06D') THEN '18C'
 when PRIMARY_LEVEL in ('06M','06V','06W','06Y','07J') THEN '26A'
 when PRIMARY_LEVEL in ('01C','01R','02D','02F') THEN '27D'
 when PRIMARY_LEVEL in ('02N','02W','02R') THEN '36J'
 when PRIMARY_LEVEL in ('07V','08J','08R','08P','08T','08X') THEN '36L'
 when PRIMARY_LEVEL in ('03D','03E','03M') THEN '42D'
 when PRIMARY_LEVEL in ('04E','04H','04K','04L','04M','04N') THEN '52R'
 when PRIMARY_LEVEL in ('09G','09H','09X') THEN '70F'
 when PRIMARY_LEVEL in ('03T','04D','99D','04Q') THEN '71E'
 when PRIMARY_LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN '72Q'
 when PRIMARY_LEVEL in ('03V','04G') THEN '78H'
 when PRIMARY_LEVEL in ('00D','00J') THEN '84H'
 when PRIMARY_LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN '91Q'
 when PRIMARY_LEVEL in ('09L','09N','09Y','99H') THEN '92A'
 when PRIMARY_LEVEL in ('11E','12D','99N') THEN '92G'
 when PRIMARY_LEVEL in ('07M','07R','07X','08D','08H') THEN '93C'
 when PRIMARY_LEVEL in ('09F','09P','99K') THEN '97R'
 ELSE PRIMARY_LEVEL
 END AS PRIMARY_LEVEL_FIXED,

 case when PRIMARY_LEVEL in ('00C','00K','00M') THEN 'NHS TEES VALLEY CCG'
 when PRIMARY_LEVEL in ('05F','05J','05T','06D') THEN 'NHS HEREFORDSHIRE AND WORCESTERSHIRE CCG'
 when PRIMARY_LEVEL in ('06M','06V','06W','06Y','07J') THEN 'NHS NORFOLK AND WAVENEY CCG'
 when PRIMARY_LEVEL in ('01C','01R','02D','02F') THEN 'NHS CHESHIRE CCG'
 when PRIMARY_LEVEL in ('02N','02W','02R') THEN 'NHS BRADFORD DISTRICT AND CRAVEN CCG'
 when PRIMARY_LEVEL in ('07V','08J','08R','08P','08T','08X') THEN 'NHS SOUTH WEST LONDON CCG'
 when PRIMARY_LEVEL in ('03D','03E','03M') THEN 'NHS NORTH YORKSHIRE CCG'
 when PRIMARY_LEVEL in ('04E','04H','04K','04L','04M','04N') THEN 'NHS NOTTINGHAM AND NOTTINGHAMSHIRE CCG'
 when PRIMARY_LEVEL in ('09G','09H','09X') THEN 'NHS WEST SUSSEX CCG'
 when PRIMARY_LEVEL in ('03T','04D','99D','04Q') THEN 'NHS LINCOLNSHIRE CCG'
 when PRIMARY_LEVEL in ('07N','07Q','08A','08K','08L','08Q') THEN 'NHS SOUTH EAST LONDON CCG'
 when PRIMARY_LEVEL in ('03V','04G') THEN 'NHS NORTHAMPTONSHIRE CCG'
 when PRIMARY_LEVEL in ('00D','00J') THEN 'NHS COUNTY DURHAM CCG'
 when PRIMARY_LEVEL in ('09C','09E','09J','09W','10A','10D','10E','99J') THEN 'NHS KENT AND MEDWAY CCG'
 when PRIMARY_LEVEL in ('09L','09N','09Y','99H') THEN 'NHS SURREY HEARTLANDS CCG'
 when PRIMARY_LEVEL in ('11E','12D','99N') THEN 'NHS BATH AND NORTH EAST SOMERSET, SWINDON AND WILTSHIRE CCG'
 when PRIMARY_LEVEL in ('07M','07R','07X','08D','08H') THEN 'NHS NORTH CENTRAL LONDON CCG'
 when PRIMARY_LEVEL in ('09F','09P','99K') THEN 'NHS EAST SUSSEX CCG'
 ELSE PRIMARY_LEVEL_DESCRIPTION
 END AS PRIMARY_LEVEL_DESCRIPTION_FIXED,

 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.CYP_monthly_expanded

# COMMAND ----------

# DBTITLE 1,5. Group CCGs for CYP Monthly
 %sql

 CREATE OR REPLACE GLOBAL TEMP VIEW CYP_monthly_expanded_Apr20_group AS
 SELECT 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED AS PRIMARY_LEVEL,
 PRIMARY_LEVEL_DESCRIPTION_FIXED AS PRIMARY_LEVEL_DESCRIPTION, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SUM(METRIC_VALUE) AS METRIC_VALUE,
 SOURCE_DB
 FROM global_temp.CYP_monthly_expanded_Apr20_map
 GROUP BY 
 REPORTING_PERIOD_START, 
 REPORTING_PERIOD_END, 
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL_FIXED,
 PRIMARY_LEVEL_DESCRIPTION_FIXED, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 SOURCE_DB

# COMMAND ----------

# DBTITLE 1,5.Cache CYP monthly
 %sql

 INSERT INTO $db_output.all_products_cached 
 SELECT 5 AS PRODUCT_NO, 
 REPORTING_PERIOD_START,
 REPORTING_PERIOD_END,
 STATUS, 
 BREAKDOWN, 
 PRIMARY_LEVEL, 
 PRIMARY_LEVEL_DESCRIPTION, 
 SECONDARY_LEVEL, 
 SECONDARY_LEVEL_DESCRIPTION, 
 METRIC, 
 METRIC_NAME, 
 METRIC_VALUE, 
 SOURCE_DB
 FROM global_temp.CYP_monthly_expanded_Apr20_group

# COMMAND ----------

# DBTITLE 1,8.Cache FYFV Quarterly 
# only needs to run for quarterly (i.e. when month_id is divisible by 3 with no remainder) and data are final
status = dbutils.widgets.get("status")
db_output = dbutils.widgets.get("db_output")
month_id = dbutils.widgets.get("month_id")

is_quarter = int(month_id) % 3 ==0

# original (no SOURCE_DB) code
# sql = "INSERT INTO {db_output}.all_products_cached SELECT 8 AS PRODUCT_NO, REPORTING_PERIOD_START, REPORTING_PERIOD_END, STATUS, BREAKDOWN, PRIMARY_LEVEL, PRIMARY_LEVEL_DESCRIPTION, SECONDARY_LEVEL, SECONDARY_LEVEL_DESCRIPTION, METRIC, METRIC_NAME, METRIC_VALUE FROM global_temp.FYFV_expanded".format(db_output=db_output)

# code below includes SOURCE_DB 
sql = "INSERT INTO {db_output}.all_products_cached SELECT 8 AS PRODUCT_NO, REPORTING_PERIOD_START, REPORTING_PERIOD_END, STATUS, BREAKDOWN, PRIMARY_LEVEL, PRIMARY_LEVEL_DESCRIPTION, SECONDARY_LEVEL, SECONDARY_LEVEL_DESCRIPTION, METRIC, METRIC_NAME, METRIC_VALUE, SOURCE_DB FROM global_temp.FYFV_expanded".format(db_output=db_output)

if is_quarter and status != 'Provisional':
  print(is_quarter, status)
  print(sql)
  spark.sql(sql).collect()
else:
  print(is_quarter, status)

# COMMAND ----------

