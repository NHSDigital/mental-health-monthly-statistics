# Databricks notebook source
# DBTITLE 1,Inpatient Investigation - Example 1
 %sql
 select * from $user_id.CMH_Access_Refs1
 where UniqServReqID = 'RX3420746'
 order by uniqmonthid

# COMMAND ----------

# DBTITLE 1,Inpatient Investigation - Example 1
 %sql
 select * from $user_id.NHSE_Pre_Proc_Inpatients
 where UniqServReqID = 'RX3420746' ---correct - this referral is not in inpatient table - should be included in output

# COMMAND ----------

 %sql
 select h.uniqmonthid, h.person_id, h.uniqservreqid
 FROM $reference_data.mhs501hospprovspell h
 LEFT JOIN $reference_data.mhs502wardstay w ON h.UniqServReqID = w.UniqServReqID 
                                       AND h.UniqHospProvSpellID = w.UniqHospProvSpellID  --updated for v5
                                       AND h.RecordNumber = w.RecordNumber
 where h.UniqServReqID = 'RX3420746'

# COMMAND ----------

# DBTITLE 1,Referral in Contacts - Example 1
 %sql
 select * from $user_id.CMH_Activity
 where UniqServReqID = 'RX3420746'

# COMMAND ----------

# DBTITLE 1,Inpatient Investigation - Example 2
 %sql
 select * from $user_id.CMH_Access_Refs1
 where UniqServReqID = '8K832FTB6381 44066'
 order by uniqmonthid

# COMMAND ----------

# DBTITLE 1,Inpatient Investigation - Example 2
 %sql
 select * from $user_id.NHSE_Pre_Proc_Inpatients
 where UniqServReqID = '8K832FTB6381 44066' ---correct - this referral is not in inpatient table - should be included in output

# COMMAND ----------

 %sql
 select h.uniqmonthid, h.person_id, h.uniqservreqid
 FROM $reference_data.mhs501hospprovspell h
 LEFT JOIN $reference_data.mhs502wardstay w ON h.UniqServReqID = w.UniqServReqID 
                                       AND h.UniqHospProvSpellID = w.UniqHospProvSpellID  --updated for v5
                                       AND h.RecordNumber = w.RecordNumber
 where h.UniqServReqID = '8K832FTB6381 44066'

# COMMAND ----------

# DBTITLE 1,Referral in Contacts - Example 2
 %sql
 select * from $user_id.CMH_Activity
 where UniqServReqID = '8K832FTB6381 44066'

# COMMAND ----------

# DBTITLE 1,Inpatient Investigation - Example 3
 %sql
 select * from $user_id.CMH_Access_Refs1
 where UniqServReqID = 'DGT5216'
 order by uniqmonthid

# COMMAND ----------

# DBTITLE 1,Inpatient Investigation - Example 3
 %sql
 select * from $user_id.NHSE_Pre_Proc_Inpatients
 where UniqServReqID = 'DGT5216'---correct - this referral is not in inpatient table - should be included in output

# COMMAND ----------

 %sql
 select h.uniqmonthid, h.person_id, h.uniqservreqid
 FROM $reference_data.mhs501hospprovspell h
 LEFT JOIN $reference_data.mhs502wardstay w ON h.UniqServReqID = w.UniqServReqID 
                                       AND h.UniqHospProvSpellID = w.UniqHospProvSpellID  --updated for v5
                                       AND h.RecordNumber = w.RecordNumber
 where h.UniqServReqID = 'DGT5216'

# COMMAND ----------

 %sql
 select * from $user_id.CMH_Activity
 where UniqServReqID = 'DGT5216'

# COMMAND ----------

# DBTITLE 1,Inpatient Investigation - Example 4
 %sql
 select * from $user_id.CMH_Access_Refs1
 where UniqServReqID = 'NKD148369450'
 order by uniqmonthid

# COMMAND ----------

 %sql
 select * from $user_id.NHSE_Pre_Proc_Inpatients
 where UniqServReqID = 'NKD148369450'---correct - this referral is not in inpatient table - should be included in output

# COMMAND ----------

 %sql
 select h.uniqmonthid, h.person_id, h.uniqservreqid
 FROM $reference_data.mhs501hospprovspell h
 LEFT JOIN $reference_data.mhs502wardstay w ON h.UniqServReqID = w.UniqServReqID 
                                       AND h.UniqHospProvSpellID = w.UniqHospProvSpellID  --updated for v5
                                       AND h.RecordNumber = w.RecordNumber
 where h.UniqServReqID = 'NKD148369450'

# COMMAND ----------

 %sql
 select * from $user_id.CMH_Activity
 where UniqServReqID = 'NKD148369450'

# COMMAND ----------

# DBTITLE 1,Bringing in some Non-Matching Referrals
import pandas as pd
import io

data = """UniqServReqID
NQL101110
NQL102721
NQL106834
NQL112049
NQL113919
NQL120521
NQL121135
NQL122365
NQL122565
NQL134618
NQL136156
NQL137247
NQL140717
NQL142013
NQL151947
NQL153638
NQL162601
NQL162606
NQL162832
NQL162992
NQL165624
NQL166816
NQL171303
NQL172019
NQL175011
NQL179050
NQL181998
NQL182372
NQL185308
NQL188698
NQL191563
NQL193767
NQL194394
NQL194745
NQL3776
NQL58916
NQL61330
NQL63245
NQL6490
NQL72177
NQL72200
NQL77605
NQL78032
NQL81064
NQL8618
NQL87853
NQL90381
NQL98090
NQLS139846159
NQLS142646370
NQLS144213516
NQLS170684702
NQLS171322588
NQLS171430702
NQLS171596574
NQLS172269210
NQLS172623806
NQLS172862888
NQLS174354182
NQLS174564438
NQLS174951716
NQLS175070621
NQLS175769389
NQLS175853665
NQLS175983422
NQLS175983423
NQLS178605356
NQLS179169239
NQLS179260572
NQLS179297201
NQLS179501596
NQLS179933945
NQLS180095086
NQLS180203852
NQLS180265348
NQLS181701401
NQLS181799059
NQLS181838698
NQLS182575533
NQLS183389240
NQLS214530294
NQLS214531172
NQLS214630969
NQLS214632468
NQLS214632557
NQLS214633447
NQLS214634905
NQLS214635025
NQLS214635092
NQLS214635247
NQLS214635696
NQLS214637266
NQLS214637525
NQLS214638928
NQLS214639292
NQLS214639326
NQLS214639393
NQLS214639395
NQLS214639403
NQLS214639718
NQLS214639725
NQLS214639787
NQLS214640110
NQLS214641059
NQLS214641076
NQLS214641384
NQLS214642124
NQLS214642595
NQLS214642601
NQLS214643525
NQLS214644757
NQLS214645765
NQLS214663571
NQLS214666397
NQLS220347424
NQLS230111942
NQLS231185148
NQLS240911622
NQLS252863003
NQLS259523438
NQLS260390037
NQLS263643556
NQLS267725154
NQLS540356130
NQLS543167876
NQLS546072305
NQLS546310925
NQLS546541470
NQLS546937757
NQLS547436698
NQLS550053508
NQLS550254167
NQLS553755079
NQLS554451164
NQLS558413719
NQLS558441514
NQLS559362036
NQLS559396186
NQLS559861544
NQLS559878023
NQLS560516659
NQLS560671686
NQLS561180901
NQLS561467258
NQLS561877828
NQLS563077057
NQLS563354337
NQLS563399795
NQLS563915087
NQLS563961608
NQLS565306307
NQLS565803913
NQLS565999438
NQLS567551620
NQLS567846303
NQLS567907596
NQLS568134372
NQLS569463059
NQLS571395378
NQLS572107045
NQLS572197458
NQLS575499704
NQLS576132690
NQLS576568925
NQLS576807269
NQLS576906144
NQLS577035122
NQLS582644538
NQLS584199780
NQLS584700211
NQLS587479143
NQLS587715603
NQLS588079957
NQLS588287076
NQLS588994799
NQLS589011648
NQLS589084837
NQLS589136697
NQLS589190534
NQLS590052398
NQLS590269460
NQLS590492718
NQLS592404133
NQLS592447261
NQLS592606332
NQLS593185639
NQLS593770792
NQLS593981059
NQLS594348888
NQLS594626392
NQLS595235838
NQLS596210841
NQLS596545559
NQLS596745067
NQLS597099319
NQLS597446535
NQLS598624835
NQLS598854430
NQLS598895155
NQLS599604286
NQLS599809790
NQLS599826868
NQLS600894752
NQLS601035381
NQLS601035383
NQLS601287691
NQLS601570420
NQLS602360224
NQLS602612452
NQLS602659951
NQLS602893032
NQLS602934392
NQLS603073795
NQLS603338734
NQLS603423982
NQLS603610457
NQLS603645181
NQLS603645183
NQLS603843098
NQLS671152734
NQLS671362173
NQLS671825866
NQLS672186037
NQLS673253528
NQLS673358137
NQLS673868190
NQLS674461224
NQLS674574719
NQLS674657887
NQLS674823148
NQLS674856868
NQLS674887096
NQLS676002570
NQLS676002572
NQLS676124110
NQLS676592020
NQLS676681686
NQLS676857271
NQLS678372769
NQLS679110594
NQLS679590941
NQLS679844149
NQLS680877173
NQLS681278300
NQLS681283836
NQLS681463673
NQLS682015452
NQLS682367086
NQLS682382353
NQLS682587806
NQLS682594585
NQLS682684366
NQLS684291729
NQLS686554364
NQLS687510718
NR5104215196
NR5111486804
NR5114174809
NR5114690651
NR5116513206
NR5117663873
NR5118331395
NR5118986073
NR5120496510
NR5129109948
NR5133423006
NR5134384568
NR5135920314
NR5137137253
NR5137478454
NR5142268641
NR5142382339
NR5142547478
NR5142547479
NR5142678471
NR5146866071
NR5148290886
NR5149181989
NR5149941732
NR5150537626
NR5159831728
NR5164614874
NR5167894340
NR5168420295
NR5168743592
NR5169337223
NR5169526613
NR5170282763
NR5170403522
NR5170666611
NR5171296047
NR5171424604
NR5171805736
NR5172064228
NR5172074275
NR5172074288
NR5172074307
NR5172142436
NR5172185945
NR5172522806
NR5172595356
NR5172652675
NR5172670041
NR5172874378
NR5173023517
NR5173177233
NR5173213202
NR5173315574
NR5173365297
NR5173485882
NR5173554554
NR5173634082
NR5173764572
NR5173880057
NR5173893434
NR5174189274
NR5174216763
NR5174247576
NR5174254270
NR5174316914
NR5174437312
NR5174491765
NR5174637173
NR5174769662
NR5174806944
NR5174833725
NR5174833742
NR5174976151
NR5175178472
NR5175203760
NR5175238460
NR5175451518
NR5175693948
NR5176036159
NR5176094785
NR5176205921
NR5177205327
NR5177768530
NR5178708568
NR5178976423
NR5179161385
NR5179687426
NR5179741106
NR5180058721
NR5180063501
NR5180080100
NR5180103838
NR5180265717
NR5180349572
NR5180613137
NR5181339864
NR5181740092
NR5181787778
NR5181821356
NR5182234637
NR5182234640
NR5182236286
NR5182431787
NR5182527343
NR5182713525
NR5182785101
NR5182941988
NR5182969065
NR5183121790
NR5183149142
NR5183423782
NR5183541533
NR5183687005
NR5184542812
NR5185401444
NR5197987170
NR5212497756
NR5213342971
NR5216372552
NR5217364101
NR5226003915
NR5230669788
NR5231782003
NR5238806187
NR5243779474
NR524608855
NR524616224
NR5248366466
NR5249127420
NR5252628146
NR5252898402
NR5253583922
NR5253808246
NR5254853588
NR5255842296
NR5256075139
NR5256197187
NR5258567250
NR5259870945
NR5263615549
NR5264575492
NR5265780895
NR528009560
NR528045155
NR529096961
NR533213857
NR5539126795
NR5541019198
NR5541745797
NR5541962926
NR5542003763
NR5546509717
NR5548396872
NR5549575603
NR5549916420
NR5551538173
NR5553440887
NR5553702120
NR5553738648
NR5553772742
NR5554157358
NR5555389988
NR5556682712
NR5557808658
NR5557891627
NR5558198118
NR5558229952
NR555828243
NR5558296536
NR5558309737
NR5558376635
NR5558682309
NR5558791911
NR5558889078
NR5559303666
NR5559362955
NR5559379251
NR5559510430
NR5559866568
NR5559875221
NR5560156094
NR5560250069
NR5560306541
NR5560645305
NR5560668015
NR5560686959
NR5560932860
NR5560991126
NR5561015197
NR5561063982
NR5561211699
NR5561477255
NR5561497395
NR5561540306
NR5561596836
NR5561738952
NR556181970
NR5561945205
NR5562420671
NR5562611729
NR5562630972
NR5562792551
NR5563770340
NR5563842082
NR5563891127
NR5564140868
NR5564547386
NR5564840688
NR5564973366
NR5565550399
NR5565612034
NR5565751256
NR5565834149
NR556585114
NR556610791
NR5566322904
NR5566334061
NR5566434417
NR5566434427
NR5566437559
NR5566437562
NR5566900103
NR5567026246
NR5567128915
NR5567933425
NR5567943967
NR5568163756
NR5568253490
NR5568462531
NR5568541670
NR5569312514
NR5569399529
NR5569399551
NR5569425742
NR5569469374
NR5569587910
NR5569794020
NR5569830315
NR5570041030
NR5570041032
NR5570041034
NR5570382393
NR5570450524
NR5571471805
NR5572846106
NR5573628249
NR5573632006
NR5573658275
NR5573705974
NR5573705975
NR5573711028
NR5573711033
NR5573732207
NR5573735452
NR5573754878
NR5573754879
NR5573763161
NR5573768038
NR5573771601
NR5573890803
NR5573890807
NR5573890810
NR5574154564
NR5574253766
NR5574254982
NR5574270655
NR5576666422
NR557776226
NR557784858
NR5578336153
NR557847452
NR557879883
NR557889732
NR557893529
NR557893708
NR5579051880
NR5579264245
NR557929436
NR5580159965
NR5580444754
NR558239333
NR5582433264
NR558263016
NR5583020085
NR5584604438
NR5584659565
NR5584659568
NR5584675674
NR5585080740
NR5585157026
NR5585286153
NR5585628848
NR5585860288
NR5585906728
NR5586311829
NR5586455327
NR5586459542
NR5586832891
NR5586997931
NR5587204526
NR5587223965
NR5587400518
NR5587613058
NR5587640421
NR5587883883
NR5588180449
NR5588293560
NR5588758436
NR5588911219
NR5589003706
NR5589403805
NR5589511027
NR5589804583
NR5589874445
NR5589948886
NR5590065985
NR5590232820
NR5590348029
NR5590697157
NR5590729810
NR5591037587
NR5591037595
NR5591419681
NR5591502171
NR5591718032
NR5591802213
NR5591917058
NR5591965572
NR5592075932
NR5592081079
NR559220322
NR5592343269
NR5592533924
NR5592577404
NR5592594273
NR5592631654
NR5593202656
NR5593283452
NR5593808287
NR5593870912
NR5594100800
NR5594169247
NR5594265800
NR5594336956
NR5594510970
NR5594510972
NR5594518719
NR5594640224
NR5595005366
NR5595430677
NR5595474128
NR5595850290
NR5596168165
NR5596176493
NR5596232708
NR5596482426
NR5596536569
NR5596571929
NR5596683579
NR5596685580
NR5596868308
NR5597002227
NR5597162059
NR5597281728
NR5597313727
NR5597417111
NR5598096622
NR5598115877
NR5598200201
NR5598245448
NR5598274716
NR5598466035
NR5598531551
NR5598601792
NR5598931408
NR5598959848
NR5599062856
NR5599281083
NR5599332391
NR5599437817
NR5599649191
NR5599701881
NR5599875868
NR5599912843
NR5600031679
NR5600102787
NR5600306488
NR5600650903
NR5600922991
NR5600930305
NR5601495441
NR5601759412
NR5601961558
NR5602002304
NR5602111649
NR5602116734
NR5602595682
NR5602654339
NR5603138822
NR5603155590
NR5603977031
NR562302649
NR562520134
NR564429406
NR565784083
NR566863674
NR5671144729
NR5671282589
NR5671312294
NR5671478817
NR5671795380
NR5671824227
NR5672043544
NR5672213113
NR5672407485
NR5672869201
NR5673030899
NR5673030900
NR5673259676
NR5673369608
NR5673493041
NR5673493049
NR5673629473
NR5673629742
NR5673629743
NR5673638312
NR5673939106
NR5673955985
NR5674064276
NR5674128152
NR5674328915
NR5674420194
NR5674528735
NR5674637574
NR5674742259
NR5674822624
NR5674910901
NR5675031787
NR5675101611
NR5675112640
NR5675142155
NR5675228287
NR5675280314
NR5675426086
NR5675640565
NR5675707425
NR5675793078
NR5676020537
NR5676079216
NR5676189101
NR5676386351
NR5676949583
NR5677233299
NR5677353357
NR5677434112
NR5677487349
NR5677539990
NR5677872837
NR5677908026
NR5678003117
NR5678403498
NR5678424354
NR5678618475
NR5678782398
NR5678961644
NR5678985829
NR5679300386
NR5679347397
NR5679404256
NR5679409140
NR5679715323
NR5679862204
NR5679903198
NR5679907437
NR5680138860
NR5680145591
NR5680310492
NR5680582712
NR5680769232
NR5680865582
NR5680959003
NR5680963021
NR5681116106
NR5681301657
NR5681497434
NR5681670445
NR5681705421
NR5682158228
NR5682241661
NR5682241662
NR5682385562
NR5682475261
NR5682529321
NR5683041023
NR5683130628
NR5683242901
NR5683814454
NR5683893860
NR5683995697
NR5684095129
NR5684394445
NR5684570020
NR5684932139
NR5684937102
NR5685001477
NR5685530110
NR5686257218
NR5686325215
NR5686379471
NR5686628507
NR5686751061
NR570101852
NR571375628
NR580022457
NR586819470
NR587566193
NR589233635
NR590174621
NR590976548
NR594346017
NR595705186
NR598311950
NYA74612
R1A1000460
R1A1000539
R1A1000615
R1A1001007
R1A1001133
R1A1001202
R1A1001300
R1A1002545
R1A1002610
R1A1003063
R1A1003937
R1A1005346
R1A1006789
R1A1006927
R1A1011405
R1A1014174
R1A1014403
R1A1014655
R1A1015019
R1A1016559
R1A1017416
R1A1017713
"""
df = pd.read_csv(io.StringIO(data), header=0, delimiter=',').astype(str)
spark.createDataFrame(df).createOrReplaceGlobalTempView("cmh_non_matching_referrals")

# COMMAND ----------

# DBTITLE 1,Looking at Non-Matching Referrals (~800) to see if any appear in MHS501 + MHS502
 %sql
 select h.uniqmonthid, h.person_id, h.uniqservreqid
 FROM $reference_data.mhs501hospprovspell h
 LEFT JOIN $reference_data.mhs502wardstay w ON h.UniqServReqID = w.UniqServReqID 
                                       AND h.UniqHospProvSpellID = w.UniqHospProvSpellID  --updated for v5
                                       AND h.RecordNumber = w.RecordNumber
 where h.UniqServReqID in (select UniqServReqID from global_temp.cmh_non_matching_referrals)
 order by uniqservreqid, uniqmonthid

# COMMAND ----------

 %sql
 select * from $user_id.NHSE_Pre_Proc_Referral
 where UniqServReqID = 'NR5172142436'
 order by uniqmonthid

# COMMAND ----------

 %sql
 select * from $user_id.NHSE_Pre_Proc_Inpatients
 where UniqServReqID = 'NR5172142436' ---Inpatient stay not in current financial year so should be kept in output

# COMMAND ----------

 %sql
 select * from $user_id.NHSE_Pre_Proc_Referral
 where UniqServReqID = 'NR5180265717'
 order by uniqmonthid

# COMMAND ----------

 %sql
 select * from $user_id.NHSE_Pre_Proc_Inpatients
 where UniqServReqID = 'NR5180265717' ---Inpatient stay not in current financial year so should be kept in output

# COMMAND ----------

 %sql
 select * from $user_id.NHSE_Pre_Proc_Referral
 where UniqServReqID = 'NR5553738648'
 order by uniqmonthid

# COMMAND ----------

 %sql
 select * from $user_id.NHSE_Pre_Proc_Inpatients
 where UniqServReqID = 'NR5180265717' ---Inpatient stay not in current financial year so should be kept in output

# COMMAND ----------

 %sql
 select * from $user_id.NHSE_Pre_Proc_Referral
 where UniqServReqID = 'NR5559510430'
 order by uniqmonthid

# COMMAND ----------

 %sql
 select * from $user_id.NHSE_Pre_Proc_Inpatients
 where UniqServReqID = 'NR5559510430' ---Inpatient stay not in current financial year so should be kept in output

# COMMAND ----------

 %sql
 select h.uniqmonthid, h.person_id, h.uniqservreqid
 FROM $reference_data.mhs501hospprovspell h
 LEFT JOIN $reference_data.mhs502wardstay w ON h.UniqServReqID = w.UniqServReqID 
                                       AND h.UniqHospProvSpellID = w.UniqHospProvSpellID  --updated for v5
                                       AND h.RecordNumber = w.RecordNumber
 where h.UniqServReqID in (select UniqServReqID from global_temp.cmh_non_matching_referrals)
 and h.UniqMonthID between 1453 and 1459 ---Hospital Spell in current financial year (April 2021) to Reporting Period (October 2021)
 order by uniqservreqid, uniqmonthid

# COMMAND ----------

 %sql
 select h.uniqmonthid, h.person_id, h.uniqservreqid
 FROM $reference_data.mhs501hospprovspell h
 LEFT JOIN $reference_data.mhs502wardstay w ON h.UniqServReqID = w.UniqServReqID 
                                       AND h.UniqHospProvSpellID = w.UniqHospProvSpellID  --updated for v5
                                       AND h.RecordNumber = w.RecordNumber
 where h.UniqServReqID in (select UniqServReqID from global_temp.cmh_non_matching_referrals)
 and h.StartDateHospProvSpell between '2021-04-01' and '2021-10-31' ---Hospital Spell in current financial year (April 2021) to Reporting Period (October 2021)
 order by uniqservreqid, uniqmonthid

# COMMAND ----------

 %sql
 select * from $user_id.CMH_Access_Refs1
 where UniqServReqID = 'NR5172142436'
 order by uniqmonthid

# COMMAND ----------

 %sql
 select * from $user_id.NHSE_Pre_Proc_Inpatients
 where UniqServReqID = 'NR5172142436'

# COMMAND ----------

 %sql
 select * from $user_id.CMH_Activity
 where UniqServReqID = 'NR5172142436'

# COMMAND ----------

 %sql
 select * from $reference_data.calendar_financial_year

# COMMAND ----------

 %sql
 select distinct uniqmonthid, reportingperiodstartdate, reportingperiodenddate, label
 from $reference_data.mhs000header h
 left join $reference_data.calendar_financial_year fy on h.reportingperiodstartdate between fy.START_DATE and fy.END_DATE
 order by 1 desc

# COMMAND ----------

import json
dbutils.notebook.exit(json.dumps({
  "status": "OK"
}))